<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Course Eligibility / QR Setup - ARMY HRMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body {
      font-family: "Inter", sans-serif;
      background: #f1f3f5;
      color: #1f2937;
    }
        .container{display:flex;height:100vh}
        .main{flex:1;padding:24px;overflow:auto}
        .header h2{font-size:26px;font-weight:700}
        .header p{color:#6b7280;margin-top:4px}
        .card{background:#fff;border-radius:12px;padding:20px;margin-top:20px;border:1px solid #e5e7eb}
        .card-title{font-size:18px;font-weight:700;margin-bottom:16px}
        .label{font-weight:600;margin-bottom:6px;display:block}
        .input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
        textarea{min-height:90px}
        .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .mt{margin-top:16px}
        .info{background:#ecfdf5;border:1px solid #34d399;padding:12px;border-radius:8px;margin-top:12px;font-weight:600}
        .rank-list{display:flex;flex-direction:column;gap:8px}
        .rank-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid #e0e0e0;border-radius:6px}
        .pills{display:flex;flex-wrap:wrap;gap:10px}
        .pill{padding:8px 14px;border-radius:20px;border:1px solid #cfd6e0;background:#f7f9fc;cursor:pointer}
        .pill.active{background:#065f46;color:#fff;border-color:#065f46}
        .selected-box{margin-top:16px;padding:12px;background:#f1f4f8;border-radius:6px;display:none}
        .actions{display:flex;justify-content:flex-end;gap:12px;margin-top:24px}
        .btn{padding:10px 18px;border-radius:8px;font-weight:600;cursor:pointer}
        .btn-secondary{background:#fff;border:1px solid #065f46;color:#065f46}
        .btn-primary{background:#065f46;color:#fff;border:none}
    </style>
</head>

<body><script src="auth.js"></script>
<script src="logout.js"></script>

<div class="container">

<!--    <aside class="sidebar">-->
<!--        <h1>ARMY HRMS</h1>-->
<!--        <a href="#">Dashboard</a>-->
<!--        <a class="active">Course Eligibility / QR</a>-->
<!--    </aside>-->
    <div id="sidebar"></div>

    <main class="main">

        <div class="header">
            <h2>Course Eligibility / QR Setup</h2>
            <p>Define qualification requirements for automatic panel filtering</p>
        </div>

        <!-- COURSE -->
        <div class="card">
            <div class="card-title">ðŸŽ“ Select Course</div>
            <label class="label">Course Name / Number *</label>
            <select id="courseSelect">
                <option value="">Select Course</option>
            </select>
            <div class="info" id="courseInfo" style="display:none"></div>
        </div>

        <!-- ELIGIBILITY -->
        <div class="card">
            <div class="card-title">ðŸ“‹ Eligibility Criteria (QR)</div>

            <div class="grid-2">
                <div>
                    <label class="label">Minimum Years</label>
                    <input id="minYears" class="input" value="6">
                </div>
                <div>
                    <label class="label">Maximum Years</label>
                    <input id="maxYears" class="input" value="16">
                </div>
            </div>

            <!-- RANKS -->
            <div class="card">
                <div class="card-title">ðŸŽ– Select Ranks</div>
                <div class="rank-list" id="rankList">Loading ranksâ€¦</div>
                <div class="selected-box" id="selectedRanks"></div>
            </div>

            <!-- UNITS -->
            <div class="card">
                <label class="label">Specific Units / Arms / Services</label>
                <div class="pills" id="unitPills">Loading unitsâ€¦</div>
                <div class="selected-box" id="selectedUnits"></div>
            </div>

            <div class="grid-2 mt">
                <div>
                    <label class="label">Minimum Course Grading</label>
                    <input id="minCourseGrading" class="input" value="B in JC">
                </div>
                <div>
                    <label class="label">Educational Qualification</label>
                    <input id="educationalQualification" class="input" value="Graduate">
                </div>
            </div>

            <div class="mt">
                <label class="label">Maximum Service Limit</label>
                <input id="maxServiceLimit" class="input" value="15 years">
            </div>

            <!-- POSTING -->
            <div class="card">
                <label class="label">Posting Criteria</label>
                <div class="pills" id="postingPills">Loading posting typesâ€¦</div>
                <div class="selected-box" id="selectedPostings"></div>
            </div>

            <div class="mt">
                <label class="label">Medical Category</label>
                <input id="medicalCategory" class="input" value="SHAPE-1">
            </div>

            <div class="mt">
                <label class="label">Additional Remarks</label>
                <textarea id="additionalRemarks">Must have field tenure</textarea>
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="saveEligibility">Save Eligibility Criteria</button>
            </div>

        </div>
    </main>
</div>

<script>
    let selectedCourseId=null,selectedUnits=[],selectedPostings=[];

    // COURSE
    fetch('http://localhost:6060/api/course').then(r=>r.json()).then(data=>{
      data.forEach(c=>{
        let o=document.createElement('option');
        o.value=c.srno;
        o.textContent=c.courseName;
        o.dataset.course=JSON.stringify(c);
        courseSelect.appendChild(o);
      });
    });
    courseSelect.onchange=function(){
      if(!this.value)return;
      let c=JSON.parse(this.options[this.selectedIndex].dataset.course);
      selectedCourseId=c.srno;
      courseInfo.style.display='block';
      courseInfo.innerHTML=`Selected: <b>${c.courseName}</b><br>Location: ${c.location} | Duration: ${c.duration} Weeks | Strength: 30`;
    };

    // RANKS
    fetch('http://localhost:6060/api/ranks/master').then(r=>r.json()).then(ranks=>{
      rankList.innerHTML='';
      ranks.forEach(r=>{
        rankList.innerHTML+=`<label class="rank-item">
          <input type="checkbox" value="${r.id}"> ${r.rank}
        </label>`;
      });
    });
    function getRankIds(){
      return [...document.querySelectorAll('#rankList input:checked')].map(i=>Number(i.value));
    }

    // UNITS
    fetch('http://localhost:6060/api/unit').then(r=>r.json()).then(units=>{
      unitPills.innerHTML='';
      units.forEach(u=>{
        let d=document.createElement('div');
        d.className='pill';
        d.textContent=u.unitName;
        d.onclick=()=>{
          d.classList.toggle('active');
          selectedUnits=selectedUnits.some(x=>x.id===u.id)
            ? selectedUnits.filter(x=>x.id!==u.id)
            : [...selectedUnits,{id:u.id}];
        };
        unitPills.appendChild(d);
      });
    });

    // POSTING
    fetch('http://localhost:6060/api/postingtypes').then(r=>r.json()).then(p=>{
      postingPills.innerHTML='';
      p.forEach(x=>{
        let d=document.createElement('div');
        d.className='pill';
        d.textContent=x.postingType;
        d.onclick=()=>{
          d.classList.toggle('active');
          selectedPostings=selectedPostings.some(y=>y.id===x.id)
            ? selectedPostings.filter(y=>y.id!==x.id)
            : [...selectedPostings,{id:x.id}];
        };
        postingPills.appendChild(d);
      });
    });

    // SAVE
    saveEligibility.onclick=()=>{
      const payload={
        courseId:selectedCourseId,
        minYears:+minYears.value,
        maxYears:+maxYears.value,
        rankIds:getRankIds(),
        unitIds:selectedUnits.map(u=>u.id),
        postingTypeIds:selectedPostings.map(p=>p.id),
        minCourseGrading:minCourseGrading.value,
        educationalQualification:educationalQualification.value,
        maxServiceLimit:maxServiceLimit.value,
        medicalCategory:medicalCategory.value,
        additionalRemarks:additionalRemarks.value
      };

      fetch('http://localhost:6060/api/eligibility/save',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      }).then(r=>{
        if(!r.ok)throw Error();
        alert('Saved successfully');
      }).catch(()=>alert('Save failed'));
    };
</script>

</body>
</html>