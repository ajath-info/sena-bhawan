<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Course Eligibility / QR Setup - ARMY HRMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body {
            font-family: "Inter", sans-serif;
            background: #f1f3f5;
            color: #1f2937;
        }
        .container{display:flex;height:100vh}
        .main{flex:1;padding:24px;overflow:auto}
        .header h2{font-size:26px;font-weight:700}
        .header p{color:#6b7280;margin-top:4px}
        .card{background:#fff;border-radius:12px;padding:20px;margin-top:20px;border:1px solid #e5e7eb}
        .card-title{font-size:18px;font-weight:700;margin-bottom:16px}
        .label{font-weight:600;margin-bottom:6px;display:block}
        .input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
        textarea{min-height:90px}
        .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
        .mt{margin-top:16px}
        .info{background:#ecfdf5;border:1px solid #34d399;padding:12px;border-radius:8px;margin-top:12px;font-weight:600}
        .rank-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;border:1px solid #e5e7eb;padding:12px;border-radius:8px}
        .rank-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid #e0e0e0;border-radius:6px}
        .pills{display:flex;flex-wrap:wrap;gap:10px}
        .pill{padding:8px 14px;border-radius:20px;border:1px solid #cfd6e0;background:#f7f9fc;cursor:pointer;user-select:none}
        .pill.active{background:#065f46;color:#fff;border-color:#065f46}
        .selected-box{margin-top:16px;padding:12px;background:#f1f4f8;border-radius:6px;display:none}
        .actions{display:flex;justify-content:flex-end;gap:12px;margin-top:24px}
        .btn{padding:10px 18px;border-radius:8px;font-weight:600;cursor:pointer}
        .btn-secondary{background:#fff;border:1px solid #065f46;color:#065f46}
        .btn-primary{background:#065f46;color:#fff;border:none}
        .section-divider{margin:20px 0;border-top:2px solid #e5e7eb}
        .select2-container{width:100% !important;}
    </style>
</head>
<body>
<script src="auth.js"></script>
<script src="logout.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container">
    <div id="sidebar"></div>

    <main class="main">
        <div class="header">
            <h2>Course Eligibility / QR Setup</h2>
            <p>Define qualification requirements for automatic panel filtering</p>
        </div>

        <!-- COURSE SELECTION -->
        <div class="card">
            <div class="card-title">üéì Select Course</div>
            <label class="label">Course Name / Number *</label>
            <select id="courseSelect" class="input">
                <option value="">Select Course</option>
            </select>
            <div class="info" id="courseInfo" style="display:none"></div>
        </div>

        <!-- ELIGIBILITY CRITERIA -->
        <div class="card">
            <div class="card-title">üìã Eligibility Criteria (QR)</div>

            <!-- Date Filters -->
            <div class="card mt">
                <div class="card-title">üìÖ Date Filters</div>

                <div class="grid-2">
                    <div>
                        <label class="label">Commission Date From</label>
                        <input type="date" id="commissionFrom" class="input">
                    </div>
                    <div>
                        <label class="label">Commission Date To</label>
                        <input type="date" id="commissionTo" class="input">
                    </div>
                </div>

                <div class="grid-2 mt">
                    <div>
                        <label class="label">Seniority Date From</label>
                        <input type="date" id="seniorityFrom" class="input">
                    </div>
                    <div>
                        <label class="label">Seniority Date To</label>
                        <input type="date" id="seniorityTo" class="input">
                    </div>
                </div>

                <div class="grid-2 mt">
                    <div>
                        <label class="label">Date of Birth From</label>
                        <input type="date" id="dobFrom" class="input">
                    </div>
                    <div>
                        <label class="label">Date of Birth To</label>
                        <input type="date" id="dobTo" class="input">
                    </div>
                </div>
            </div>

            <!-- Ranks Selection -->
            <div class="card mt">
                <div class="card-title">üéñ Select Ranks</div>
                <div class="rank-list" id="rankList">Loading ranks‚Ä¶</div>
            </div>

            <!-- Units Selection -->
            <div class="card mt">
                <div class="card-title">üè¢ Select Units / Arms / Services</div>
                <div class="rank-list" id="unitList">Loading units‚Ä¶</div>
            </div>

            <!-- Posting Type Selection -->
            <div class="card mt">
                <div class="card-title">üìå Posting Types</div>
                <div class="rank-list" id="postingTypeList">Loading posting types‚Ä¶</div>
            </div>

            <!-- Multi-select Dropdowns using /api/dropdown/{type} -->
            <div class="grid-2 mt">
                <div>
                    <label class="label">Minimum Course Grading</label>
                    <select id="minCourseGrading" class="input select2-multi" multiple></select>
                </div>
                <div>
                    <label class="label">Educational Qualifications</label>
                    <select id="educationalQualifications" class="input select2-multi" multiple></select>
                </div>
            </div>

            <div class="grid-2 mt">
                <div>
                    <label class="label">Medical Categories</label>
                    <select id="medicalCategories" class="input select2-multi" multiple></select>
                </div>
                <div>
                    <label class="label">Establishment Types</label>
                    <select id="establishmentTypes" class="input select2-multi" multiple></select>
                </div>
            </div>

            <!-- Remarks -->
            <div class="card mt">
                <div class="card-title">üìù Remarks</div>
                <div class="pills" id="remarksPills">
                    <div class="pill" data-value="Taken Off">Taken Off</div>
                    <div class="pill" data-value="Volunteer">Volunteer</div>
                    <div class="pill" data-value="Not to Detail">Not to Detail</div>
                </div>
            </div>

            <div class="mt">
                <label class="label">Additional Remarks</label>
                <textarea id="additionalRemarks" class="input">Must have field tenure</textarea>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" id="loadEligibility">Load Existing</button>
                <button class="btn btn-primary" id="saveEligibility">Save Eligibility Criteria</button>
            </div>
        </div>
    </main>
</div>

<script>
    // State management
    let selectedCourseId = null;
    let selectedRankIds = [];
    let selectedUnitIds = [];
    let selectedPostingTypeIds = [];
    let selectedRemarks = [];

    // Mapping of dropdown types to their API endpoints and element IDs
    const dropdownConfig = {
        minCourseGrading: {
            type: 'COURSE_GRADE',
            elementId: 'minCourseGrading'
        },
        educationalQualifications: {
            type: 'CIVIL_QUALIFICATION',
            elementId: 'educationalQualifications'
        },
        medicalCategories: {
            type: 'MEDICAL',
            elementId: 'medicalCategories'
        },
        establishmentTypes: {
            type: 'ESTABLISHMENT',
            elementId: 'establishmentTypes'
        }
    };

    // Initialize all event listeners and data loading
    document.addEventListener('DOMContentLoaded', function() {
        loadCourses();
        loadRanks();
        loadUnits();
        loadPostingTypes();
        loadAllDropdowns();
        initializePillListeners();
        initializeSelect2();
    });

    function initializeSelect2() {
        $('.select2-multi').select2({
            placeholder: 'Select options',
            allowClear: true,
            width: '100%'
        });
    }

    // Load all dropdown data from the new API
    function loadAllDropdowns() {
        Object.values(dropdownConfig).forEach(config => {
            loadDropdown(config.type, config.elementId);
        });
    }

    // Generic function to load dropdown data from /api/dropdown/{type}
    function loadDropdown(type, elementId) {
        const select = document.getElementById(elementId);
        if (!select) return;

        fetch(`http://localhost:6060/api/dropdown/${type}`)
            .then(response => {
                if (!response.ok) throw new Error(`Failed to load ${type} dropdown`);
                return response.json();
            })
            .then(data => {
                select.innerHTML = '';
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    select.appendChild(option);
                });
                $(`#${elementId}`).trigger('change');
            })
            .catch(error => {
                console.error(`Error loading ${type} dropdown:`, error);
                select.innerHTML = '<option value="">Failed to load options</option>';
            });
    }

    // Load Courses
    function loadCourses() {
        fetch('http://localhost:6060/api/course')
            .then(response => {
                if (!response.ok) throw new Error('Failed to load courses');
                return response.json();
            })
            .then(data => {
                const courseSelect = document.getElementById('courseSelect');
                courseSelect.innerHTML = '<option value="">Select Course</option>';
                data.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.srno;
                    option.textContent = c.courseName;
                    option.dataset.course = JSON.stringify(c);
                    courseSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading courses:', error);
                alert('Failed to load courses');
            });
    }

    // Course selection handler - NOW WITH AUTO-LOAD
    document.getElementById('courseSelect').addEventListener('change', function() {
        if (!this.value) {
            document.getElementById('courseInfo').style.display = 'none';
            resetForm(); // Reset all fields when no course is selected
            return;
        }

        const selectedOption = this.options[this.selectedIndex];
        const course = JSON.parse(selectedOption.dataset.course);
        selectedCourseId = course.srno;

        const courseInfo = document.getElementById('courseInfo');
        courseInfo.style.display = 'block';
        courseInfo.innerHTML = `
            Selected: <b>${course.courseName}</b><br>
            Location: ${course.location || 'N/A'} |
            Duration: ${course.duration || 'N/A'} Weeks
        `;

        // AUTO-LOAD eligibility data when course is selected
        loadEligibilityForCourse(selectedCourseId);
    });

    // Function to reset form
    function resetForm() {
        // Reset date fields
        document.getElementById('commissionFrom').value = '';
        document.getElementById('commissionTo').value = '';
        document.getElementById('seniorityFrom').value = '';
        document.getElementById('seniorityTo').value = '';
        document.getElementById('dobFrom').value = '';
        document.getElementById('dobTo').value = '';

        // Reset additional remarks
        document.getElementById('additionalRemarks').value = '';

        // Reset checkboxes
        document.querySelectorAll('#rankList input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        document.querySelectorAll('#unitList input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        document.querySelectorAll('#postingTypeList input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });

        // Reset selected arrays
        selectedRankIds = [];
        selectedUnitIds = [];
        selectedPostingTypeIds = [];

        // Reset multi-select dropdowns
        $('#minCourseGrading').val([]).trigger('change');
        $('#educationalQualifications').val([]).trigger('change');
        $('#medicalCategories').val([]).trigger('change');
        $('#establishmentTypes').val([]).trigger('change');

        // Reset remarks pills
        selectedRemarks = [];
        document.querySelectorAll('#remarksPills .pill').forEach(pill => {
            pill.classList.remove('active');
        });
    }

    // Function to load eligibility data for a course
    function loadEligibilityForCourse(courseId) {
        fetch(`http://localhost:6060/api/eligibility/course/${courseId}`)
            .then(response => {
                if (response.status === 404) {
                    console.log('No existing eligibility found for this course');
                    resetForm(); // Reset form if no data exists
                    return null;
                }
                if (!response.ok) throw new Error('Failed to load eligibility');
                return response.json();
            })
            .then(data => {
                if (data) {
                    populateForm(data);
                    console.log('Eligibility data auto-loaded successfully');
                }
            })
            .catch(error => {
                console.error('Error loading eligibility:', error);
                resetForm(); // Reset on error as well
            });
    }

    // Populate form with existing data
    function populateForm(data) {
        // Date fields
        document.getElementById('commissionFrom').value = data.commissionDateFrom || '';
        document.getElementById('commissionTo').value = data.commissionDateTo || '';
        document.getElementById('seniorityFrom').value = data.seniorityDateFrom || '';
        document.getElementById('seniorityTo').value = data.seniorityDateTo || '';
        document.getElementById('dobFrom').value = data.dobFrom || '';
        document.getElementById('dobTo').value = data.dobTo || '';

        // Additional remarks
        document.getElementById('additionalRemarks').value = data.additionalRemarks || '';

        // Ranks
        if (data.rankIds && data.rankIds.length > 0) {
            selectedRankIds = data.rankIds;
            document.querySelectorAll('#rankList input[type="checkbox"]').forEach(cb => {
                cb.checked = selectedRankIds.includes(Number(cb.value));
            });
        } else {
            selectedRankIds = [];
            document.querySelectorAll('#rankList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // Units
        if (data.unitIds && data.unitIds.length > 0) {
            selectedUnitIds = data.unitIds;
            document.querySelectorAll('#unitList input[type="checkbox"]').forEach(cb => {
                cb.checked = selectedUnitIds.includes(Number(cb.value));
            });
        } else {
            selectedUnitIds = [];
            document.querySelectorAll('#unitList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // Posting Types
        if (data.postingTypeIds && data.postingTypeIds.length > 0) {
            selectedPostingTypeIds = data.postingTypeIds;
            document.querySelectorAll('#postingTypeList input[type="checkbox"]').forEach(cb => {
                cb.checked = selectedPostingTypeIds.includes(Number(cb.value));
            });
        } else {
            selectedPostingTypeIds = [];
            document.querySelectorAll('#postingTypeList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // Multi-select dropdowns - set values by IDs
        if (data.minCourseGrading && data.minCourseGrading.length > 0) {
            $('#minCourseGrading').val(data.minCourseGrading.map(id => String(id))).trigger('change');
        } else {
            $('#minCourseGrading').val([]).trigger('change');
        }

        if (data.educationalQualifications && data.educationalQualifications.length > 0) {
            $('#educationalQualifications').val(data.educationalQualifications.map(id => String(id))).trigger('change');
        } else {
            $('#educationalQualifications').val([]).trigger('change');
        }

        if (data.medicalCategories && data.medicalCategories.length > 0) {
            $('#medicalCategories').val(data.medicalCategories.map(id => String(id))).trigger('change');
        } else {
            $('#medicalCategories').val([]).trigger('change');
        }

        if (data.establishmentTypes && data.establishmentTypes.length > 0) {
            $('#establishmentTypes').val(data.establishmentTypes.map(id => String(id))).trigger('change');
        } else {
            $('#establishmentTypes').val([]).trigger('change');
        }

        // Remarks
        if (data.remarks && data.remarks.length > 0) {
            selectedRemarks = data.remarks;
            document.querySelectorAll('#remarksPills .pill').forEach(pill => {
                pill.classList.toggle('active', data.remarks.includes(pill.dataset.value));
            });
        } else {
            selectedRemarks = [];
            document.querySelectorAll('#remarksPills .pill').forEach(pill => {
                pill.classList.remove('active');
            });
        }
    }

    // Load Ranks
    function loadRanks() {
        fetch('http://localhost:6060/api/ranks/master')
            .then(response => {
                if (!response.ok) throw new Error('Failed to load ranks');
                return response.json();
            })
            .then(ranks => {
                const rankList = document.getElementById('rankList');
                rankList.innerHTML = '';

                ranks.forEach(rank => {
                    const label = document.createElement('label');
                    label.className = 'rank-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = rank.id;
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            if (!selectedRankIds.includes(rank.id)) {
                                selectedRankIds.push(rank.id);
                            }
                        } else {
                            selectedRankIds = selectedRankIds.filter(id => id !== rank.id);
                        }
                    });

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(` ${rank.rank}`));
                    rankList.appendChild(label);
                });
            })
            .catch(error => {
                console.error('Error loading ranks:', error);
                document.getElementById('rankList').innerHTML = 'Failed to load ranks';
            });
    }

    // Load Units
    function loadUnits() {
        fetch('http://localhost:6060/api/unit')
            .then(response => {
                if (!response.ok) throw new Error('Failed to load units');
                return response.json();
            })
            .then(units => {
                const unitList = document.getElementById('unitList');
                unitList.innerHTML = '';

                units.forEach(unit => {
                    const label = document.createElement('label');
                    label.className = 'rank-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = unit.id;
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            if (!selectedUnitIds.includes(unit.id)) {
                                selectedUnitIds.push(unit.id);
                            }
                        } else {
                            selectedUnitIds = selectedUnitIds.filter(id => id !== unit.id);
                        }
                    });

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(` ${unit.unitName}`));
                    unitList.appendChild(label);
                });
            })
            .catch(error => {
                console.error('Error loading units:', error);
                document.getElementById('unitList').innerHTML = 'Failed to load units';
            });
    }

    // Load Posting Types
    function loadPostingTypes() {
        fetch('http://localhost:6060/api/postingtypes')
            .then(response => {
                if (!response.ok) throw new Error('Failed to load posting types');
                return response.json();
            })
            .then(types => {
                const postingList = document.getElementById('postingTypeList');
                postingList.innerHTML = '';

                types.forEach(type => {
                    const label = document.createElement('label');
                    label.className = 'rank-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = type.id;
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            if (!selectedPostingTypeIds.includes(type.id)) {
                                selectedPostingTypeIds.push(type.id);
                            }
                        } else {
                            selectedPostingTypeIds = selectedPostingTypeIds.filter(id => id !== type.id);
                        }
                    });

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(` ${type.postingType}`));
                    postingList.appendChild(label);
                });
            })
            .catch(error => {
                console.error('Error loading posting types:', error);
                document.getElementById('postingTypeList').innerHTML = 'Failed to load posting types';
            });
    }

    // Initialize pill listeners
    function initializePillListeners() {
        document.querySelectorAll('#remarksPills .pill').forEach(pill => {
            pill.addEventListener('click', function() {
                this.classList.toggle('active');
                const value = this.dataset.value;
                if (this.classList.contains('active')) {
                    if (!selectedRemarks.includes(value)) {
                        selectedRemarks.push(value);
                    }
                } else {
                    selectedRemarks = selectedRemarks.filter(v => v !== value);
                }
            });
        });
    }

    // Manual load button (kept for backward compatibility)
    document.getElementById('loadEligibility').addEventListener('click', function() {
        if (!selectedCourseId) {
            alert('Please select a course first');
            return;
        }
        loadEligibilityForCourse(selectedCourseId);
    });

    // Save eligibility
    document.getElementById('saveEligibility').addEventListener('click', function() {
        if (!selectedCourseId) {
            alert('Please select a course');
            return;
        }

        const payload = {
            courseId: selectedCourseId,
            commissionDateFrom: document.getElementById('commissionFrom').value || null,
            commissionDateTo: document.getElementById('commissionTo').value || null,
            seniorityDateFrom: document.getElementById('seniorityFrom').value || null,
            seniorityDateTo: document.getElementById('seniorityTo').value || null,
            dobFrom: document.getElementById('dobFrom').value || null,
            dobTo: document.getElementById('dobTo').value || null,
            rankIds: selectedRankIds,
            unitIds: selectedUnitIds,
            postingTypeIds: selectedPostingTypeIds,
            minCourseGrading: $('#minCourseGrading').val() || [],
            educationalQualifications: $('#educationalQualifications').val() || [],
            medicalCategories: $('#medicalCategories').val() || [],
            establishmentTypes: $('#establishmentTypes').val() || [],
            remarks: selectedRemarks,
            additionalRemarks: document.getElementById('additionalRemarks').value || null
        };

        console.log('Saving payload:', payload);

        fetch('http://localhost:6060/api/eligibility/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Save failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('Eligibility criteria saved successfully!');
                console.log('Saved data:', data);
            })
            .catch(error => {
                console.error('Error saving eligibility:', error);
                alert('Failed to save eligibility criteria: ' + error.message);
            });
    });
</script>
</body>
</html>