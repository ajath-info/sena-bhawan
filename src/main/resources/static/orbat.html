<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Create ORBAT Entry - ARMY HRMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: "Inter", sans-serif; background:#f1f3f5; color:#1f2937; }
        .container { display:flex; height:100vh; }

        /* SIDEBAR */
        .sidebar { width:260px; background:linear-gradient(180deg,#1b4332,#081c15); color:white; }
        .sidebar-header { padding:20px; border-bottom:1px solid rgba(255,255,255,0.1); }
        .logo { display:flex; gap:12px; align-items:center; }
        .logo-icon { width:32px;height:32px; background:#ffb703; border-radius:6px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#000; }
        .sidebar-nav { padding:16px 0; }
        .nav-title { padding:16px 20px 8px; font-size:11px; text-transform:uppercase; color:#52b788; font-weight:700; }
        .nav-item { padding:12px 20px; display:flex; gap:12px; align-items:center; color:white; text-decoration:none; }
        .nav-item.active { background:rgba(255,255,255,0.1); border-left:4px solid #ffb703; font-weight:600; }

        /* MAIN */
        .main { flex:1; display:flex; flex-direction:column; }
        .header { background:white; padding:20px 24px; border-bottom:1px solid #e5e7eb; }
        .header h2 { font-size:22px; }
        .header p { font-size:13px; color:#6b7280; }

        .content { padding:32px; overflow-y:auto; }

        /* FORM */
        .form-grid {
          max-width:900px;
          display:grid;
          grid-template-columns:repeat(2,1fr);
          gap:20px;
        }
        .form-group { display:flex; flex-direction:column; gap:6px; }
        .full { grid-column:1 / -1; }

        label { font-size:14px; font-weight:600; }
        input, select {
          padding:12px;
          border:1px solid #d1d5db;
          border-radius:8px;
          font-size:14px;
          background:white;
        }
        input:focus, select:focus {
          border-color:#1b4332;
          box-shadow:0 0 0 3px rgba(27,67,50,0.15);
          outline:none;
        }

        .actions { margin-top:30px; display:flex; justify-content:flex-end; gap:12px; }
        .btn {
          padding:12px 20px;
          border-radius:8px;
          font-size:14px;
          cursor:pointer;
          font-weight:600;
          border:1px solid transparent;
        }
        .btn-primary { background:#1b4332; color:white; }
        .btn-primary:disabled { background:#6b7280; cursor:not-allowed; }
        .btn-secondary { background:white; border:1px solid #d1d5db; color:#374151; }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">üõ°Ô∏è</div>
                <div><strong>ARMY HRMS</strong><br><small style="color:#52b788">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§∏‡•á‡§®‡§æ</small></div>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-title">Forms</div>
            <a href="#" class="nav-item active">
                <div class="nav-icon">üìã</div>
                <span>ORBAT Creation</span>
            </a>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main">
        <div class="header">
            <h2>ARMY HQ ‚Äì ORBAT Creation</h2>
            <p>Create hierarchical formation structure</p>
        </div>

        <div class="content">
            <div class="form-grid" id="formGrid">
                <!-- ARMY HQ Dropdown - /api/orbat/hq -->
                <div class="form-group full">
                    <label>Army HQ *</label>
                    <select id="hqId">
                        <option value="">Loading Army HQ...</option>
                    </select>
                </div>

                <!-- Formation Type - /api/dropdown/FORMATION_TYPE -->
                <div class="form-group full">
                    <label>What do you want to create? *</label>
                    <select id="formationType">
                        <option value="">Select Type</option>
                    </select>
                </div>

                <!-- Command Dropdown - /api/orbat/commands -->
                <div class="form-group full" id="commandGroup" style="display: none;">
                    <label>Select Command *</label>
                    <select id="commandId">
                        <option value="">Select Command</option>
                    </select>
                </div>

                <!-- Corps Dropdown - /api/orbat/corps -->
                <div class="form-group full" id="corpsGroup" style="display: none;">
                    <label>Select Corps *</label>
                    <select id="corpsId">
                        <option value="">Select Corps</option>
                    </select>
                </div>

                <!-- Division Dropdown - /api/orbat/divisions -->
                <div class="form-group full" id="divisionGroup" style="display: none;">
                    <label>Select Division *</label>
                    <select id="divisionId">
                        <option value="">Select Division</option>
                    </select>
                </div>

                <!-- Brigade Dropdown - /api/orbat/brigades -->
                <div class="form-group full" id="brigadeGroup" style="display: none;">
                    <label>Select Brigade *</label>
                    <select id="brigadeId">
                        <option value="">Select Brigade</option>
                    </select>
                </div>

                <!-- Common Fields -->
                <div class="form-group full" id="nameGroup" style="display: none;">
                    <label>Name of Est *</label>
                    <input id="name" type="text" placeholder="Enter Name of Est">
                </div>

                <div class="form-group" id="locationGroup" style="display: none;">
                    <label>Location *</label>
                    <input id="location" type="text" placeholder="Enter Location">
                </div>

                <div class="form-group" id="susNoGroup" style="display: none;">
                    <label>SUS Number *</label>
                    <input id="susNo" type="text" placeholder="Enter SUS Number">
                </div>

                <div class="form-group" id="pinGroup" style="display: none;">
                    <label>PIN *</label>
                    <input id="pin" type="text" placeholder="Enter PIN">
                </div>

                <!-- Area Type Dropdown - /api/dropdown/AREA_TYPE -->
                <div class="form-group" id="areaTypeGroup" style="display: none;">
                    <label>Area Type *</label>
                    <select id="areaType">
                        <option value="">Loading Area Types...</option>
                    </select>
                </div>

                <!-- Unit Type Dropdown - /api/dropdown/UNIT_TYPE -->
                <div class="form-group full" id="unitTypeGroup" style="display: none;">
                    <label>Type of Unit *</label>
                    <select id="unitType">
                        <option value="">Loading Unit Types...</option>
                    </select>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="window.location.reload()">Cancel</button>
                <button class="btn btn-primary" id="submitBtn" disabled>Create ORBAT Entry</button>
            </div>
        </div>
    </main>
</div>

<script>
    class ORBATCreator {
        constructor() {
            this.baseUrl = 'http://localhost:6060/api';
            // Hierarchy mapping for different formation types
            this.hierarchyMap = {
                'Command': [],  // No parent dependencies
                'Corps': ['command'],
                'Division': ['command', 'corps'],
                'Brigade': ['command', 'corps', 'division'],
                'Unit': ['command', 'corps', 'division', 'brigade']
            };

            this.init();
        }

        async init() {
            await this.loadHqDropdown();
            await this.loadFormationTypes();
            await this.loadAreaTypes(); // Load Area Types from /api/dropdown/AREA_TYPE
            await this.loadUnitTypes(); // Load Unit Types from /api/dropdown/UNIT_TYPE
            this.setupEventListeners();
        }

        setupEventListeners() {
            // Formation type change
            document.getElementById('formationType').addEventListener('change', (e) => {
                this.handleFormationTypeChange(e.target.value);
            });

            // Hierarchy dropdown changes
            document.getElementById('commandId').addEventListener('change', (e) => {
                if (e.target.value) {
                    this.loadCorpsDropdown(e.target.value);
                } else {
                    this.clearLowerDropdowns('corps');
                }
            });

            document.getElementById('corpsId').addEventListener('change', (e) => {
                if (e.target.value) {
                    this.loadDivisionDropdown(e.target.value);
                } else {
                    this.clearLowerDropdowns('division');
                }
            });

            document.getElementById('divisionId').addEventListener('change', (e) => {
                if (e.target.value) {
                    this.loadBrigadeDropdown(e.target.value);
                } else {
                    this.clearLowerDropdowns('brigade');
                }
            });

            // Form validation on any input change
            document.addEventListener('input', () => this.validateForm());
            document.addEventListener('change', () => this.validateForm());
        }

        clearLowerDropdowns(startLevel) {
            const levels = ['corps', 'division', 'brigade'];
            const startIndex = levels.indexOf(startLevel);

            if (startIndex >= 0) {
                for (let i = startIndex; i < levels.length; i++) {
                    const level = levels[i];
                    const select = document.getElementById(`${level}Id`);
                    if (select) {
                        select.innerHTML = `<option value="">Select ${level.charAt(0).toUpperCase() + level.slice(1)}</option>`;
                        select.value = '';
                    }
                }
            }
        }

        // Load Army HQ dropdown - /api/orbat/hq
        async loadHqDropdown() {
            const select = document.getElementById('hqId');

            try {
                const response = await fetch(`${this.baseUrl}/orbat/hq`);
                if (!response.ok) throw new Error('Failed to load HQ data');

                const data = await response.json();

                let options = '<option value="">Select Army HQ</option>';
                if (data && data.length > 0) {
                    options += data.map(item =>
                        `<option value="${item.id}">${item.name}</option>`
                    ).join('');
                }

                select.innerHTML = options;
            } catch (error) {
                console.error('Error loading HQ:', error);
                select.innerHTML = '<option value="">Error loading HQ</option>';
            }
        }

        // Load Formation Types - /api/dropdown/FORMATION_TYPE
        async loadFormationTypes() {
            const select = document.getElementById('formationType');

            try {
                const response = await fetch(`${this.baseUrl}/dropdown/FORMATION_TYPE`);
                if (!response.ok) throw new Error('Failed to load formation types');

                const data = await response.json();

                let options = '<option value="">Select Type</option>';
                if (data && data.length > 0) {
                    options += data.map(item =>
                        `<option value="${item.name}">${item.name}</option>`
                    ).join('');
                }

                select.innerHTML = options;
            } catch (error) {
                console.error('Error loading formation types:', error);
                select.innerHTML = '<option value="">Error loading types</option>';
            }
        }

        // Load Command dropdown - /api/orbat/commands
        async loadCommandDropdown() {
            const select = document.getElementById('commandId');

            try {
                const response = await fetch(`${this.baseUrl}/orbat/commands`);
                if (!response.ok) throw new Error('Failed to load commands');

                const data = await response.json();

                let options = '<option value="">Select Command</option>';
                if (data && data.length > 0) {
                    options += data.map(item =>
                        `<option value="${item.id}">${item.name}</option>`
                    ).join('');
                }

                select.innerHTML = options;
            } catch (error) {
                console.error('Error loading commands:', error);
                select.innerHTML = '<option value="">Error loading commands</option>';
            }
        }

        // Load Corps dropdown filtered by command - /api/orbat/corps?commandId=xxx
        async loadCorpsDropdown(commandId) {
            const select = document.getElementById('corpsId');
            select.innerHTML = '<option value="">Loading Corps...</option>';

            try {
                const url = commandId
                    ? `${this.baseUrl}/orbat/corps?commandId=${commandId}`
                    : `${this.baseUrl}/orbat/corps`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load corps');

                const data = await response.json();

                let options = '<option value="">Select Corps</option>';
                if (data && data.length > 0) {
                    options += data.map(item =>
                        `<option value="${item.id}">${item.name}</option>`
                    ).join('');
                }

                select.innerHTML = options;
            } catch (error) {
                console.error('Error loading corps:', error);
                select.innerHTML = '<option value="">Error loading corps</option>';
            }
        }

        // Load Division dropdown filtered by corps - /api/orbat/divisions?corpsId=xxx
        async loadDivisionDropdown(corpsId) {
            const select = document.getElementById('divisionId');
            select.innerHTML = '<option value="">Loading Divisions...</option>';

            try {
                const url = corpsId
                    ? `${this.baseUrl}/orbat/divisions?corpsId=${corpsId}`
                    : `${this.baseUrl}/orbat/divisions`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load divisions');

                const data = await response.json();

                let options = '<option value="">Select Division</option>';
                if (data && data.length > 0) {
                    options += data.map(item =>
                        `<option value="${item.id}">${item.name}</option>`
                    ).join('');
                }

                select.innerHTML = options;
            } catch (error) {
                console.error('Error loading divisions:', error);
                select.innerHTML = '<option value="">Error loading divisions</option>';
            }
        }

        // Load Brigade dropdown filtered by division - /api/orbat/brigades?divisionId=xxx
        async loadBrigadeDropdown(divisionId) {
            const select = document.getElementById('brigadeId');
            select.innerHTML = '<option value="">Loading Brigades...</option>';

            try {
                const url = divisionId
                    ? `${this.baseUrl}/orbat/brigades?divisionId=${divisionId}`
                    : `${this.baseUrl}/orbat/brigades`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load brigades');

                const data = await response.json();

                let options = '<option value="">Select Brigade</option>';
                if (data && data.length > 0) {
                    options += data.map(item =>
                        `<option value="${item.id}">${item.name}</option>`
                    ).join('');
                }

                select.innerHTML = options;
            } catch (error) {
                console.error('Error loading brigades:', error);
                select.innerHTML = '<option value="">Error loading brigades</option>';
            }
        }

        // Load Area Types - /api/dropdown/AREA_TYPE
        async loadAreaTypes() {
            const select = document.getElementById('areaType');

            try {
                const response = await fetch(`${this.baseUrl}/dropdown/AREA_TYPE`);
                if (!response.ok) throw new Error('Failed to load area types');

                const data = await response.json();
                console.log('Area Types loaded:', data);

                let options = '<option value="">Select Area Type</option>';
                if (data && data.length > 0) {
                    options += data.map(item =>
                        `<option value="${item.name}">${item.name}</option>`
                    ).join('');
                }

                select.innerHTML = options;
            } catch (error) {
                console.error('Error loading area types:', error);
                select.innerHTML = '<option value="">Error loading area types</option>';
            }
        }

        // Load Unit Types - /api/dropdown/UNIT_TYPE
        async loadUnitTypes() {
            const select = document.getElementById('unitType');

            try {
                const response = await fetch(`${this.baseUrl}/dropdown/UNIT_TYPE`);
                if (!response.ok) throw new Error('Failed to load unit types');

                const data = await response.json();
                console.log('Unit Types loaded:', data);

                let options = '<option value="">Select Unit Type</option>';
                if (data && data.length > 0) {
                    options += data.map(item =>
                        `<option value="${item.name}">${item.name}</option>`
                    ).join('');
                }

                select.innerHTML = options;
            } catch (error) {
                console.error('Error loading unit types:', error);
                select.innerHTML = '<option value="">Error loading unit types</option>';
            }
        }

        async handleFormationTypeChange(type) {
            // Hide all groups first
            this.hideAllGroups();

            if (!type) return;

            // Show common fields
            document.getElementById('nameGroup').style.display = 'block';
            document.getElementById('locationGroup').style.display = 'block';
            document.getElementById('susNoGroup').style.display = 'block';
            document.getElementById('pinGroup').style.display = 'block';
            document.getElementById('areaTypeGroup').style.display = 'block';

            // Show/hide unit type based on selection
            if (type === 'Unit') {
                document.getElementById('unitTypeGroup').style.display = 'block';
            } else {
                document.getElementById('unitTypeGroup').style.display = 'none';
                document.getElementById('unitType').value = '';
            }

            // Show and load hierarchy dropdowns based on type
            const parents = this.hierarchyMap[type] || [];

            // Reset all hierarchy dropdowns
            this.resetHierarchyDropdowns();

            // Show and load required dropdowns
            for (const parent of parents) {
                const group = document.getElementById(`${parent}Group`);
                if (group) {
                    group.style.display = 'block';

                    // Load the dropdown data based on parent level
                    switch(parent) {
                        case 'command':
                            await this.loadCommandDropdown();
                            break;
                        case 'corps':
                            // Corps will be loaded when command is selected
                            break;
                        case 'division':
                            // Division will be loaded when corps is selected
                            break;
                        case 'brigade':
                            // Brigade will be loaded when division is selected
                            break;
                    }
                }
            }

            this.validateForm();
        }

        hideAllGroups() {
            const groups = ['commandGroup', 'corpsGroup', 'divisionGroup', 'brigadeGroup',
                           'nameGroup', 'locationGroup', 'susNoGroup', 'pinGroup',
                           'areaTypeGroup', 'unitTypeGroup'];

            groups.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
        }

        resetHierarchyDropdowns() {
            const dropdowns = ['commandId', 'corpsId', 'divisionId', 'brigadeId'];

            dropdowns.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const level = id.replace('Id', '');
                    select.innerHTML = `<option value="">Select ${level.charAt(0).toUpperCase() + level.slice(1)}</option>`;
                    select.value = '';
                }
            });
        }

        validateForm() {
            const submitBtn = document.getElementById('submitBtn');

            // Check required fields
            const hqId = document.getElementById('hqId').value;
            const formationType = document.getElementById('formationType').value;
            const name = document.getElementById('name').value.trim();
            const location = document.getElementById('location').value.trim();
            const susNo = document.getElementById('susNo').value.trim();
            const pin = document.getElementById('pin').value.trim();
            const areaType = document.getElementById('areaType').value;

            // Basic validation
            if (!hqId || !formationType || !name || !location || !susNo || !pin || !areaType) {
                submitBtn.disabled = true;
                return;
            }

            // Check hierarchy based on formation type
            const parents = this.hierarchyMap[formationType] || [];
            for (const parent of parents) {
                const parentSelect = document.getElementById(`${parent}Id`);
                if (!parentSelect || !parentSelect.value) {
                    submitBtn.disabled = true;
                    return;
                }
            }

            // Check unit type for Unit formation
            if (formationType === 'Unit') {
                const unitType = document.getElementById('unitType').value;
                if (!unitType) {
                    submitBtn.disabled = true;
                    return;
                }
            }

            submitBtn.disabled = false;
        }

        async submitForm() {
            const formationType = document.getElementById('formationType').value;

            // Get area type name (value is already the name since we set value="${item.name}")
            const areaType = document.getElementById('areaType').value;

            // Prepare payload according to FormationRequestDTO
            const payload = {
                formationType: formationType,
                hqId: parseInt(document.getElementById('hqId').value),
                commandId: this.getHierarchyId('commandId'),
                corpsId: this.getHierarchyId('corpsId'),
                divisionId: this.getHierarchyId('divisionId'),
                brigadeId: this.getHierarchyId('brigadeId'),
                name: document.getElementById('name').value.trim(),
                location: document.getElementById('location').value.trim(),
                susNo: document.getElementById('susNo').value.trim(),
                pinNo: document.getElementById('pin').value.trim(),
                areaType: areaType  // Now this will be the name, not the ID
            };

            // Add unit type if applicable (value is already the name)
            if (formationType === 'Unit') {
                payload.unitType = document.getElementById('unitType').value;
                console.log('Unit Type being sent:', payload.unitType);
            }

            console.log('Final Payload being sent:', payload);

            // Validate payload
            if (!this.validatePayload(payload, formationType)) {
                alert('Please fill all required fields');
                return;
            }

            try {
                const response = await fetch(`${this.baseUrl}/orbat/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('ORBAT Entry created successfully!');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    console.error('Error response:', error);
                    alert(`Error: ${error}`);
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                alert('Failed to create ORBAT entry');
            }
        }

        getHierarchyId(id) {
            const element = document.getElementById(id);
            return element && element.value ? parseInt(element.value) : null;
        }

        validatePayload(payload, formationType) {
            // Validate based on formation type according to your service logic
            if (formationType === 'Command' && !payload.hqId) return false;
            if (formationType === 'Corps' && !payload.commandId) return false;
            if (formationType === 'Division' && !payload.corpsId) return false;
            if (formationType === 'Brigade' && !payload.divisionId) return false;
            if (formationType === 'Unit' && !payload.brigadeId) return false;

            // Ensure areaType is present
            if (!payload.areaType) {
                console.error('Area Type is missing');
                return false;
            }

            // For Unit formation, ensure unitType is present
            if (formationType === 'Unit' && !payload.unitType) {
                console.error('Unit Type is missing for Unit formation');
                return false;
            }

            return true;
        }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
        const app = new ORBATCreator();

        // Attach submit handler
        document.getElementById('submitBtn').addEventListener('click', (e) => {
            e.preventDefault();
            app.submitForm();
        });
    });
</script>

</body>
</html>