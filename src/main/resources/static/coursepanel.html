<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Course Panel Generation - ARMY HRMS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Inter", sans-serif;
            background: #f1f3f5;
            color: #1f2937;
        }
        .nav-item {
            text-decoration: none;
            color: white;
        }
        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 256px;
            background: linear-gradient(180deg, #1b4332 0%, #081c15 100%);
            color: white;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 72px;
        }
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background: #ffb703;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        .logo-text h1 {
            font-size: 18px;
            font-weight: 700;
        }
        .logo-text p {
            font-size: 11px;
            color: #52b788;
        }
        .menu-icon {
            width: 24px;
            height: 24px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .menu-icon span {
            width: 100%;
            height: 2px;
            background: white;
            border-radius: 2px;
        }
        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }
        .nav-section-title {
            padding: 16px 20px 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #52b788;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: white;
            border-left: 4px solid transparent;
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #ffb703;
            font-weight: 600;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            font-size: 18px;
        }
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2d6a4f;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        .user-info {
            flex: 1;
        }
        .user-info .name {
            font-size: 14px;
            font-weight: 600;
        }
        .user-info .role {
            font-size: 12px;
            color: #52b788;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 72px;
        }
        .header-left h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .header-left p {
            font-size: 14px;
            color: #6b7280;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        .form-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 32px;
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        .step {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            cursor: pointer;
        }
        .step::after {
            content: "";
            position: absolute;
            left: 100%;
            top: 20px;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
            z-index: 0;
        }
        .step:last-child::after {
            display: none;
        }
        .step.active .step-number {
            background: #1b4332;
            color: white;
        }
        .step.active .step-label {
            color: #1b4332;
            font-weight: 700;
        }
        .step.completed .step-number {
            background: #10b981;
            color: white;
        }
        .step.completed::after {
            background: #10b981;
        }
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #6b7280;
            z-index: 1;
            position: relative;
        }
        .step-content {
        }
        .step-label {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
        }
        .step-desc {
            font-size: 12px;
            color: #9ca3af;
        }

        .section-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }
        .form-label .required {
            color: #ef4444;
        }
        .form-input,
        .form-select {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .strength-control {
            display: flex;
            align-items: center;
            gap: 16px;
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }
        .strength-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            flex: 1;
        }
        .strength-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .strength-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            background: #1b4332;
            color: white;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .strength-btn:hover {
            background: #081c15;
        }
        .strength-value {
            font-size: 32px;
            font-weight: 700;
            color: #1b4332;
            min-width: 80px;
            text-align: center;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .info-box strong {
            color: #1e40af;
        }
        .info-box p {
            font-size: 14px;
            color: #1e3a8a;
            line-height: 1.6;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }
        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: white;
            border: 2px solid #1b4332;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #1b4332;
            cursor: pointer;
        }
        .filter-chip.active {
            background: #1b4332;
            color: white;
        }
        .filter-chip:hover {
            background: #f0fdf4;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        .data-table thead {
            background: #f9fafb;
        }
        .data-table th {
            padding: 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #6b7280;
            border-bottom: 2px solid #e5e7eb;
        }
        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }
        .data-table tbody tr:hover {
            background: #f9fafb;
        }
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .checkbox.checked {
            background: #1b4332;
            border-color: #1b4332;
            color: white;
            font-weight: 700;
        }

        .ser-no {
            font-weight: 700;
            color: #1b4332;
        }
        .officer-name {
            font-weight: 600;
            color: #1f2937;
        }
        .officer-army-no {
            font-size: 12px;
            color: #6b7280;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-success {
            background: #d1fae5;
            color: #10b981;
        }
        .badge-warning {
            background: #fef3c7;
            color: #f59e0b;
        }
        .badge-info {
            background: #dbeafe;
            color: #3b82f6;
        }
        .badge-danger {
            background: #fee2e2;
            color: #ef4444;
        }

        .attendance-toggle {
            display: flex;
            gap: 8px;
        }
        .attendance-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 2px solid #d1d5db;
            background: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .attendance-btn.attending {
            border-color: #10b981;
            background: #d1fae5;
            color: #10b981;
        }
        .attendance-btn.not-attending {
            border-color: #ef4444;
            background: #fee2e2;
            color: #ef4444;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: #1b4332;
            color: white;
        }
        .btn-primary:hover {
            background: #2d6a4f;
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: white;
            color: #1b4332;
            border: 2px solid #1b4332;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-outline {
            background: white;
            border: 1px solid #d1d5db;
            color: #6b7280;
        }

        .summary-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #86efac;
            border-radius: 12px;
            padding: 24px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 16px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-value {
            font-size: 32px;
            font-weight: 700;
            color: #065f46;
        }
        .summary-label {
            font-size: 13px;
            color: #047857;
            margin-top: 4px;
        }
        .step-section {
            display: none;
        }

        .step-section.active {
            display: block;
        }

        .footer-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .footer-left,
        .footer-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .step-nav-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }

        .step-nav-btn .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #6b7280;
        }

        .step-nav-btn .step-label {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
        }

        .step-nav-btn .step-desc {
            font-size: 12px;
            color: #9ca3af;
        }

        .step-nav-btn.active .step-number {
            background: #1b4332;
            color: white;
        }

        .step-nav-btn.active .step-label {
            color: #1b4332;
            font-weight: 700;
        }

        .step-nav-btn.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .footer-btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .footer-btn.success {
            background: #10b981;
            color: white;
        }

        .footer-btn.secondary {
            background: white;
            border: 2px solid #1b4332;
            color: #1b4332;
        }

        .table-scroll-wrapper {
            max-height: 420px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: white;
        }

        .table-scroll-wrapper thead th {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 2;
            border-bottom: 2px solid #e5e7eb;
        }

        .data-table {
            min-width: 1400px;
        }

        .table-scroll-wrapper::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }
        .table-scroll-wrapper::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 8px;
        }

        .form-textarea {
            width: 100%;
            min-height: 96px;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: "Inter", sans-serif;
            color: #1f2937;
            background: white;
            resize: vertical;
            line-height: 1.5;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #1b4332;
            box-shadow: 0 0 0 2px rgba(27, 67, 50, 0.15);
        }

        .form-textarea::placeholder {
            color: #9ca3af;
        }

        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            position: relative;
        }

        @media (max-width: 1200px) {
            .filter-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
        }

        .filter-select[multiple] {
            height: auto;
            min-height: 120px;
        }

        .result-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .filter-grid .form-group {
            position: relative;
            z-index: auto;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #15803d;
        }

        .toast.error {
            border-left: 4px solid #dc2626;
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .clear-filters {
            font-size: 13px;
            color: #dc2626;
            cursor: pointer;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 6px;
            background: #fef2f2;
        }

        .clear-filters:hover {
            background: #fee2e2;
        }

        /* Dropdown styles */
        .dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-btn {
            border: 1px solid #ccc;
            padding: 10px;
            cursor: pointer;
            background: #f9f9f9;
            border-radius: 8px;
            user-select: none;
            position: relative;
            z-index: 2;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            border: 1px solid #ccc;
            background: white;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999 !important; /* Force highest z-index */
            border-radius: 8px;
            margin-top: 2px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .dropdown-content label {
            display: block;
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-content label:hover {
            background: #f1f1f1;
        }

        .dropdown-content label:last-child {
            border-bottom: none;
        }

        .dropdown-content input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        /* Show dropdown when focused or when active class is added */
        .dropdown:focus-within .dropdown-content,
        .dropdown.active .dropdown-content {
            display: block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            width: 100%;
            border: 1px solid #ccc;
            background: white;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999; /* Increased z-index */
            border-radius: 8px;
            margin-top: 2px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Ensure dropdown appears above other elements */
        .dropdown {
            position: relative;
            /*z-index: 100;*/
        }

        .dropdown-content {
            display: none;
            position: absolute;
            width: 100%;
            border: 1px solid #ccc;
            background: white;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
            border-radius: 8px;
            margin-top: 2px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .dropdown-content.show {
            display: block !important;
        }
    </style>
</head>
<body>
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo-section">
                <div class="logo-icon">üõ°Ô∏è</div>
                <div class="logo-text">
                    <h1>ARMY HRMS</h1>
                    <p>‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§∏‡•á‡§®‡§æ</p>
                </div>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section-title">Main Menu</div>

            <a href="/dashboard-new.html" class="nav-item">
                <div class="nav-icon">üè†</div>
                <span>Dashboard</span>
            </a>

            <a href="/dashboard-officers.html" class="nav-item">
                <div class="nav-icon">üë•</div>
                <span>Dashboard Officers</span>
            </a>

            <a href="/dashboard-training.html" class="nav-item">
                <div class="nav-icon">üìö</div>
                <span>Dashboard Training</span>
            </a>

            <a href="/filter.html" class="nav-item">
                <div class="nav-icon">üîç</div>
                <span>Master Filter & Search</span>
            </a>

            <div class="nav-section-title">Administration</div>

            <a href="/role-permmissoon.html" class="nav-item">
                <div class="nav-icon">üîê</div>
                <span>Role & Permissions</span>
            </a>

            <div class="nav-section-title">Masters</div>

            <a href="/course-master.html" class="nav-item">
                <div class="nav-icon">üìö</div>
                <span>Course Master</span>
            </a>

            <a href="/grade-awards.html" class="nav-item">
                <div class="nav-icon">üìù</div>
                <span>Grade & Awards</span>
            </a>

            <a href="/course-schedule.html" class="nav-item">
                <div class="nav-icon">üìÖ</div>
                <span>Course Schedule</span>
            </a>

            <a href="/location-master.html" class="nav-item">
                <div class="nav-icon">üìç</div>
                <span>Location Master</span>
            </a>

            <a href="/rank-master.html" class="nav-item">
                <div class="nav-icon">üèÖ</div>
                <span>Rank Master</span>
            </a>

            <a href="/unit-master.html" class="nav-item">
                <div class="nav-icon">üõ°Ô∏è</div>
                <span>Unit Master</span>
            </a>

            <div class="nav-section-title">Forms</div>

            <a href="/personnel-form.html" class="nav-item">
                <div class="nav-icon">üë§</div>
                <span>Personnel Data Form</span>
            </a>

            <a href="/coursepanel.html" class="nav-item active">
                <div class="nav-icon">üìã</div>
                <span>Course Panel Generation</span>
            </a>

            <a href="/course-posting-form.html" class="nav-item">
                <div class="nav-icon">üìù</div>
                <span>Course & Posting Form</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">AD</div>
                <div class="user-info">
                    <div class="name">Admin User</div>
                    <div class="role">HQ Command</div>
                </div>
                <div>üö™</div>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="header">
            <div class="header-left">
                <h2>Course Panel Generation</h2>
                <p>Generate and manage course nomination panels</p>
            </div>
        </header>

        <div class="content-area">
            <div class="form-container">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step">
                        <div class="step-number">‚úì</div>
                        <div class="step-content">
                            <div class="step-label">Course Selection</div>
                            <div class="step-desc">Select course</div>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">‚úì</div>
                        <div class="step-content">
                            <div class="step-label">Define Strength</div>
                            <div class="step-desc">Set panel size</div>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-label">Apply Filters</div>
                            <div class="step-desc">Select officers</div>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <div class="step-label">Review & Approve</div>
                            <div class="step-desc">Final approval</div>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <div class="step-label">Generate Letter</div>
                            <div class="step-desc">Course letter</div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Course Selection -->
                <div class="section-card step-section active" id="step-1">
                    <div class="section-title">
                        <span>üìö Step 1: Course Selection</span>
                    </div>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">
                                Selected Course <span class="required">*</span>
                            </label>

                            <select class="form-select" id="courseSelect">
                                <option value="">-- Select Course --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Course Start Date</label>
                            <input type="date" id="courseStartDate" class="form-input" readonly/>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Course End Date</label>
                            <input type="date" id="courseEndDate" class="form-input" readonly/>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Define Strength -->
                <div class="section-card step-section" id="step-2">
                    <div class="section-title">
                        <span>‚ûï Step 2: Define Panel Strength</span>
                        <span class="badge badge-success">Completed</span>
                    </div>

                    <!-- Course Strength (READ ONLY) -->
                    <div class="strength-control">
                        <div class="strength-label">
                            <div style="font-size:16px;font-weight:700;margin-bottom:4px;">
                                Course Strength
                            </div>
                            <div style="font-size:13px;color:#6b7280">
                                Total seats available for this course
                            </div>
                        </div>

                        <div class="strength-buttons">
                            <button class="strength-btn" disabled>‚àí</button>
                            <input
                                    type="number"
                                    id="courseStrength"
                                    class="strength-value"
                                    min="0"
                                    style="width:80px;text-align:center;"
                            />

                            <button class="strength-btn" disabled>+</button>
                        </div>
                    </div>

                    <!-- Panel Size (USER CONTROLLED) -->
                    <div class="strength-control" style="margin-top:16px">
                        <div class="strength-label">
                            <div style="font-size:16px;font-weight:700;margin-bottom:4px;">
                                Panel Size
                            </div>
                            <div style="font-size:13px;color:#6b7280">
                                Total officers to nominate (including buffer)
                            </div>
                        </div>

                        <div class="strength-buttons">
                            <button class="strength-btn" id="decreasePanel">‚àí</button>
                            <input
                                    type="number"
                                    id="panelSize"
                                    class="strength-value"
                                    min="0"
                                    style="width:80px;text-align:center;"
                            />

                            <button class="strength-btn" id="increasePanel">+</button>
                        </div>
                    </div>

                    <div class="info-box">
                        <strong>üí° Logic:</strong>
                        <p id="logicText">
                            Panel size = Course strength + Buffer (10)
                        </p>
                    </div>
                </div>

                <!-- Step 3: Apply Filters -->
                <div class="section-card step-section" id="step-3">
                    <div class="section-title">
                        <span>üîç Step 3: Apply Filters & Select Officers</span>
                        <span class="badge badge-info">Active</span>
                    </div>

                    <!-- Filter Button -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <button class="btn btn-primary" onclick="openFilterPopup()" style="display: flex; align-items: center; gap: 8px;">
                                <span>üîç</span>
                                Open Advanced Filters
                            </button>
                        </div>
                        <div class="badge badge-info" id="activeFilterCount" style="font-size: 13px;">0 filters applied</div>
                    </div>

                    <!-- Panel Summary -->
                    <div class="summary-box">
                        <div style="font-size: 18px; font-weight: 700; color: #065f46; text-align: center;">
                            Panel Summary
                        </div>

                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-value" id="panelTotalNominated">0</div>
                                <div class="summary-label">Total Nominated</div>
                            </div>

                            <div class="summary-item">
                                <div class="summary-value" id="panelCourseSeats">0</div>
                                <div class="summary-label">Course Seats</div>
                            </div>

                            <div class="summary-item">
                                <div class="summary-value" id="panelBufferSeats">0</div>
                                <div class="summary-label">Buffer Officers</div>
                            </div>

                            <div class="summary-item">
                                <div class="summary-value" id="panelAttendingCount">0</div>
                                <div class="summary-label">Attending</div>
                            </div>
                        </div>
                    </div>

                    <!-- Officers Table -->
                    <div style="margin-top: 24px">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 14px; font-weight: 600">
                                Selected Officers
                                (<span id="selectedCount">0</span> of
                                <span id="totalEligible">0</span> eligible)
                            </div>

                            <div style="display: flex; gap: 8px">
                                <button class="footer-btn success" id="saveToDraft">Save Draft</button>
                                <button class="btn btn-secondary" id="selectAllBtn" style="padding: 8px 16px">
                                    Select All
                                </button>
                                <button class="btn btn-secondary" id="deselectAllBtn" style="padding: 8px 16px">
                                    Deselect All
                                </button>
                            </div>
                        </div>

                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                    <tr>
                                        <th>‚úì</th>
                                        <th>Ser No</th>
                                        <th>Officer</th>
                                        <th>Rank</th>
                                        <th>Unit</th>
                                        <th>Command</th>
                                        <th>Date of Commission</th>
                                        <th>Date of Seniority</th>
                                        <th>Date of Birth</th>
                                        <th>Religion</th>
                                        <th>Marital Status</th>
                                        <th>Medical Category</th>
                                        <th>Mobile</th>
                                        <th>Email</th>
                                        <th>City</th>
                                        <th>State</th>
                                        <th>Attendance Status</th>
                                    </tr>
                                    </thead>
                                    <tbody id="officerTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Review & Approve -->
                <div class="section-card step-section" id="step-4">
                    <div class="section-title">
                        <span>üîç Step 4: Review & Approve</span>
                        <span class="badge badge-info">Active</span>
                    </div>

                    <!-- Officers Review Table -->
                    <div style="margin-top: 24px">
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                    <tr>
                                        <th>Ser No</th>
                                        <th>Officer</th>
                                        <th>Rank</th>
                                        <th>Unit</th>
                                        <th>Command</th>
                                        <th>Date of Commission</th>
                                        <th>Date of Seniority</th>
                                        <th>Date of Birth</th>
                                        <th>Religion</th>
                                        <th>Marital Status</th>
                                        <th>Medical Category</th>
                                        <th>Mobile</th>
                                        <th>Email</th>
                                        <th>City</th>
                                        <th>State</th>
                                    </tr>
                                    </thead>
                                    <tbody id="finalApprovalTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 25px">
                        <div class="section-title">
                            <span>üîç Send Panel</span>
                        </div>
                        <div class="filter-grid">
                            <div style="margin-top: 24px">
                                <div class="form-group">
                                    <label class="form-label">Send To</label>
                                    <select class="form-select" id="sendToRole">
                                        <option value="">-- Select Role --</option>
                                    </select>
                                </div>

                                <div class="form-group"></div>
                                <div class="form-group"></div>
                                <div class="form-group"></div>

                                <div class="form-group">
                                    <label class="form-label">Remarks</label>
                                    <textarea
                                            name="remarks"
                                            rows="3"
                                            class="form-textarea"
                                            id="approvalRemark"
                                            placeholder="Panel forwarded for approval"
                                    ></textarea>
                                </div>
                                <div style="margin-top: 24px">
                                    <button class="footer-btn success" id="sendToApproval">
                                        Send for Approval
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Generate Letter -->
                <div class="section-card step-section" id="step-5">
                    <div class="section-title">
                        <span>üîç Step 5: Generate Letter</span>
                        <span class="badge badge-info">Active</span>
                    </div>

                    <!-- Officers Selection Table -->
                    <div style="margin-top: 24px">
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                    <tr>
                                        <th>Ser No</th>
                                        <th>Officer</th>
                                        <th>Rank</th>
                                        <th>Unit</th>
                                        <th>Command</th>
                                        <th>Date of Commission</th>
                                        <th>Date of Seniority</th>
                                        <th>Date of Birth</th>
                                        <th>Mobile</th>
                                        <th>Email</th>
                                        <th>City</th>
                                        <th>State</th>
                                        <th>Letter</th>
                                    </tr>
                                    </thead>
                                    <tbody id="step5TableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Navigation -->
                <div class="footer-nav">
                    <div class="footer-left">
                        <div class="step-nav-btn" id="prevNav">
                            <div class="step-number">‚Üê</div>
                            <div>
                                <div class="step-label">Previous</div>
                                <div class="step-desc">Go back</div>
                            </div>
                        </div>
                    </div>

                    <div class="footer-right">
                        <div class="step-nav-btn" id="nextNav">
                            <div class="step-number">‚Üí</div>
                            <div>
                                <div class="step-label">Next</div>
                                <div class="step-desc">Continue</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Filter Popup Modal -->
<div id="filterPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="position: relative; width: 95%; max-width: 1400px; margin: 30px auto; background: white; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">

        <!-- Popup Header -->
        <div style="padding: 20px 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 12px 12px 0 0;">
            <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                <span>üîç</span> Advanced Filters
            </h3>
            <div style="display: flex; gap: 12px; align-items: center;">
                <span class="clear-filters" onclick="clearAllFilters()">Clear All</span>
                <button onclick="closeFilterPopup()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
            </div>
        </div>

        <!-- Popup Body - Filters -->
        <div style="padding: 24px; max-height: calc(100vh - 250px); overflow-y: auto;">
            <!-- Quick Search -->
            <div style="margin-bottom: 24px;">
                <label class="form-label" style="font-size: 14px; margin-bottom: 8px; display: block;">üîç Quick Search</label>
                <input type="text" class="form-input" id="globalSearch" placeholder="Search by name, army no..." style="width: 100%;">
            </div>

            <div class="filter-grid">
                <!-- Rank Filter -->
                <div class="form-group">
                    <label class="form-label">üèÖ Rank</label>
                    <div class="dropdown" tabindex="0" style="position:relative; width:100%;">
                        <div class="dropdown-btn" style="border:1px solid #ccc; padding:10px; cursor:pointer; background:#f9f9f9; border-radius:8px;" data-target="rankFilter">Select Ranks</div>
                        <div class="dropdown-content" id="dropdown-rankFilter" style="display:none; position:absolute; width:100%; border:1px solid #ccc; background:white; max-height:200px; overflow-y:auto; z-index:10; border-radius:8px; margin-top:2px;"></div>
                    </div>
                </div>

                <!-- Medical Category -->
                <div class="form-group">
                    <label class="form-label">‚öïÔ∏è Medical Category</label>
                    <div class="dropdown" tabindex="0" style="position:relative; width:100%;">
                        <div class="dropdown-btn" style="border:1px solid #ccc; padding:10px; cursor:pointer; background:#f9f9f9; border-radius:8px;" data-target="medicalFilter">Select Medical Categories</div>
                        <div class="dropdown-content" id="dropdown-medicalFilter" style="display:none; position:absolute; width:100%; border:1px solid #ccc; background:white; max-height:200px; overflow-y:auto; z-index:10; border-radius:8px; margin-top:2px;"></div>
                    </div>
                </div>

                <!-- Command -->
                <div class="form-group">
                    <label class="form-label">üìç Command</label>
                    <div class="dropdown" tabindex="0" style="position:relative; width:100%;">
                        <div class="dropdown-btn" style="border:1px solid #ccc; padding:10px; cursor:pointer; background:#f9f9f9; border-radius:8px;" data-target="commandFilter">Select Commands</div>
                        <div class="dropdown-content" id="dropdown-commandFilter" style="display:none; position:absolute; width:100%; border:1px solid #ccc; background:white; max-height:200px; overflow-y:auto; z-index:10; border-radius:8px; margin-top:2px;"></div>
                    </div>
                </div>

                <!-- Corps -->
                <div class="form-group">
                    <label class="form-label">üéØ Corps</label>
                    <div class="dropdown" tabindex="0" style="position:relative; width:100%;">
                        <div class="dropdown-btn" style="border:1px solid #ccc; padding:10px; cursor:pointer; background:#f9f9f9; border-radius:8px;" data-target="corpsFilter">Select Corps</div>
                        <div class="dropdown-content" id="dropdown-corpsFilter" style="display:none; position:absolute; width:100%; border:1px solid #ccc; background:white; max-height:200px; overflow-y:auto; z-index:10; border-radius:8px; margin-top:2px;"></div>
                    </div>
                </div>

                <!-- Division -->
                <div class="form-group">
                    <label class="form-label">üö© Division</label>
                    <div class="dropdown" tabindex="0" style="position:relative; width:100%;">
                        <div class="dropdown-btn" style="border:1px solid #ccc; padding:10px; cursor:pointer; background:#f9f9f9; border-radius:8px;" data-target="divisionFilter">Select Divisions</div>
                        <div class="dropdown-content" id="dropdown-divisionFilter" style="display:none; position:absolute; width:100%; border:1px solid #ccc; background:white; max-height:200px; overflow-y:auto; z-index:10; border-radius:8px; margin-top:2px;"></div>
                    </div>
                </div>

                <!-- Type of Establishment -->
                <div class="form-group">
                    <label class="form-label">üè¢ Type of Establishment</label>
                    <div class="dropdown" tabindex="0" style="position:relative; width:100%;">
                        <div class="dropdown-btn" style="border:1px solid #ccc; padding:10px; cursor:pointer; background:#f9f9f9; border-radius:8px;" data-target="estFilter">Select Establishment Types</div>
                        <div class="dropdown-content" id="dropdown-estFilter" style="display:none; position:absolute; width:100%; border:1px solid #ccc; background:white; max-height:200px; overflow-y:auto; z-index:10; border-radius:8px; margin-top:2px;"></div>
                    </div>
                </div>

                <!-- Area Type -->
                <div class="form-group">
                    <label class="form-label">üó∫Ô∏è Area Type</label>
                    <div class="dropdown" tabindex="0" style="position:relative; width:100%;">
                        <div class="dropdown-btn" style="border:1px solid #ccc; padding:10px; cursor:pointer; background:#f9f9f9; border-radius:8px;" data-target="areaTypeFilter">Select Area Types</div>
                        <div class="dropdown-content" id="dropdown-areaTypeFilter" style="display:none; position:absolute; width:100%; border:1px solid #ccc; background:white; max-height:200px; overflow-y:auto; z-index:10; border-radius:8px; margin-top:2px;"></div>
                    </div>
                </div>

                <!-- Civil Qualification -->
                <div class="form-group">
                    <label class="form-label">üéì Civil Qualification</label>
                    <div class="dropdown" tabindex="0" style="position:relative; width:100%;">
                        <div class="dropdown-btn" style="border:1px solid #ccc; padding:10px; cursor:pointer; background:#f9f9f9; border-radius:8px;" data-target="civilFilter">Select Qualifications</div>
                        <div class="dropdown-content" id="dropdown-civilFilter" style="display:none; position:absolute; width:100%; border:1px solid #ccc; background:white; max-height:200px; overflow-y:auto; z-index:10; border-radius:8px; margin-top:2px;"></div>
                    </div>
                </div>

                <!-- Sports -->
                <div class="form-group">
                    <label class="form-label">‚öΩ Sports</label>
                    <div class="dropdown" tabindex="0" style="position:relative; width:100%;">
                        <div class="dropdown-btn" style="border:1px solid #ccc; padding:10px; cursor:pointer; background:#f9f9f9; border-radius:8px;" data-target="sportsFilter">Select Sports</div>
                        <div class="dropdown-content" id="dropdown-sportsFilter" style="display:none; position:absolute; width:100%; border:1px solid #ccc; background:white; max-height:200px; overflow-y:auto; z-index:10; border-radius:8px; margin-top:2px;"></div>
                    </div>
                </div>

                <!-- Course Name -->
                <div class="form-group">
                    <label class="form-label">üìö Course Name</label>
                    <input type="text" class="form-input" id="courseNameFilter" placeholder="e.g. DSSC">
                </div>

                <!-- Posting Due (Months) -->
                <div class="form-group">
                    <label class="form-label">‚è∞ Posting Due (Months)</label>
                    <div class="dropdown" tabindex="0" style="position:relative; width:100%;">
                        <div class="dropdown-btn" style="border:1px solid #ccc; padding:10px; cursor:pointer; background:#f9f9f9; border-radius:8px;" data-target="postingDueFilter">Select Months</div>
                        <div class="dropdown-content" id="dropdown-postingDueFilter" style="display:none; position:absolute; width:100%; border:1px solid #ccc; background:white; max-height:200px; overflow-y:auto; z-index:10; border-radius:8px; margin-top:2px;"></div>
                    </div>
                </div>

                <!-- Place of Birth -->
                <div class="form-group">
                    <label class="form-label">üìç Place of Birth</label>
                    <input type="text" class="form-input" id="pobFilter" placeholder="Enter state/city">
                </div>
            </div>

            <!-- Date Filters Section -->
            <div style="margin-top: 30px;">
                <h4 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">üìÖ Date Filters</h4>
                <div class="filter-grid">
                    <div class="form-group">
                        <label class="form-label">DOB (Greater Than)</label>
                        <input type="date" class="form-input" id="dobFilter">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Date of Commission From</label>
                        <input type="date" class="form-input" id="docFrom">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Date of Commission To</label>
                        <input type="date" class="form-input" id="docTo">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Date of Seniority From</label>
                        <input type="date" class="form-input" id="dosFrom">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Date of Seniority To</label>
                        <input type="date" class="form-input" id="dosTo">
                    </div>

                    <div class="form-group">
                        <label class="form-label">TOS From</label>
                        <input type="date" class="form-input" id="tosFrom">
                    </div>

                    <div class="form-group">
                        <label class="form-label">TOS To</label>
                        <input type="date" class="form-input" id="tosTo">
                    </div>

                    <div class="form-group">
                        <label class="form-label">NOT on Course From</label>
                        <input type="date" class="form-input" id="courseFrom">
                    </div>

                    <div class="form-group">
                        <label class="form-label">NOT on Course To</label>
                        <input type="date" class="form-input" id="courseTo">
                    </div>
                </div>
            </div>

            <!-- Results Table inside Popup -->
            <div style="margin-top: 30px;">
                <h4 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">üìã Filter Results</h4>
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                    <div class="table-scroll-wrapper" style="max-height: 400px;">
                        <table class="data-table" id="filterResultsTable">
                            <thead>
                            <tr>
                                <th>Select</th>
                                <th>Army No</th>
                                <th>Name</th>
                                <th>Rank</th>
                                <th>Unit</th>
                                <th>Command</th>
                                <th>Medical</th>
                                <th>DOB</th>
                                <th>Commission</th>
                                <th>Mobile</th>
                            </tr>
                            </thead>
                            <tbody id="filterResultsBody">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 40px;">
                                    <div style="color: #6b7280;">Click "Apply Filters" to load results</div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popup Footer -->
        <div style="padding: 20px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc; border-radius: 0 0 12px 12px;">
            <button class="btn btn-secondary" onclick="closeFilterPopup()">Cancel</button>
            <button class="btn btn-primary" onclick="applyAdvancedFilters()" id="applyAdvancedFiltersBtn">
                <span>üîç</span> Apply Filters
            </button>
            <button class="btn btn-success" onclick="addSelectedOfficers()" id="addSelectedBtn">
                <span>‚ûï</span> Add Selected to Panel
            </button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer"></div>

<script>
    // ===============================
    // GLOBAL STATE
    // ===============================
    const TOTAL_STEPS = 5;
    let currentStep = 1;
    let officers = [];
    let attendingSet = new Set();
    const selectedSet = new Set();
    const statusMap = new Map();
    let filterResults = [];
    let courseStrength = 0;
    let panelSize = 0;
    const BUFFER = 10;

    // Add these filter state arrays here - GLOBAL SCOPE
    let rankSelected = [];
    let medicalSelected = [];
    let commandSelected = [];
    let corpsSelected = [];
    let divisionSelected = [];
    let areaTypeSelected = [];
    let estSelected = [];
    let civilSelected = [];
    let sportsSelected = [];
    let postingDueSelected = [];

    // DOM Elements
    const prevNav = document.getElementById('prevNav');
    const nextNav = document.getElementById('nextNav');
    const saveToDraft = document.getElementById('saveToDraft');
    const steps = document.querySelectorAll('.step');
    const sections = document.querySelectorAll('.step-section');

    // ===============================
    // STEP NAVIGATION
    // ===============================
    function renderStep() {
        sections.forEach(s => s.classList.remove('active'));
        document.getElementById(`step-${currentStep}`).classList.add('active');

        steps.forEach((step, index) => {
            const num = index + 1;
            const circle = step.querySelector('.step-number');
            step.classList.remove('active', 'completed');

            if (num < currentStep) {
                step.classList.add('completed');
                circle.textContent = '‚úì';
            } else if (num === currentStep) {
                step.classList.add('active');
                circle.textContent = num;
            } else {
                circle.textContent = num;
            }
        });

        prevNav.classList.toggle('disabled', currentStep === 1);
        nextNav.classList.toggle('disabled', currentStep === TOTAL_STEPS);

        if (currentStep === 4) {
            loadStep4Panel();
        }
        if (currentStep === 5) {
            loadStep5Panel();
        }

        prevNav.classList.toggle('active', currentStep > 1);
        nextNav.classList.toggle('active', currentStep < TOTAL_STEPS);
    }

    nextNav.addEventListener('click', () => {
        if (currentStep < TOTAL_STEPS) {
            currentStep++;
            renderStep();
        }
    });

    prevNav.addEventListener('click', () => {
        if (currentStep > 1) {
            currentStep--;
            renderStep();
        }
    });

    steps.forEach((step, index) => {
        step.addEventListener('click', () => {
            currentStep = index + 1;
            renderStep();
        });
    });

    saveToDraft.addEventListener('click', () => {
        if (currentStep === 3) {
            handleStep3Save();
        }
    });

    // ===============================
    // STEP 1: COURSE SELECTION
    // ===============================
    document.addEventListener("DOMContentLoaded", () => {
        const courseSelect = document.getElementById("courseSelect");
        const startDateInput = document.getElementById("courseStartDate");
        const endDateInput = document.getElementById("courseEndDate");

        fetch("http://localhost:6060/api/courseschedule/step1")
            .then(res => res.json())
            .then(courses => {
                courseSelect.innerHTML = `<option value="">-- Select Course --</option>`;

                courses.forEach(course => {
                    const option = document.createElement("option");
                    option.value = course.scheduleId;
                    option.textContent = `${course.courseName} (${course.startDate} ‚Üí ${course.endDate})`;
                    option.dataset.courseId = course.courseId;
                    option.dataset.startDate = course.startDate;
                    option.dataset.endDate = course.endDate;
                    option.dataset.scheduleId = course.scheduleId;
                    courseSelect.appendChild(option);
                });
            });

        courseSelect.addEventListener("change", async function () {
            const selectedOption = this.options[this.selectedIndex];
            const scheduleId = this.value;
            const courseId = selectedOption.dataset.courseId;

            if (!scheduleId) {
                sessionStorage.clear();
                return;
            }

            sessionStorage.setItem("scheduleId", scheduleId);
            document.getElementById("courseStartDate").value = selectedOption.dataset.startDate;
            document.getElementById("courseEndDate").value = selectedOption.dataset.endDate;

            // Load course strength for step 2
            loadStep2PanelStrength(courseId);

            // NEW: Fetch eligibility criteria and apply filters automatically
            if (courseId) {
                try {
                    showLoading(true);
                    // Call eligibility API
                    const eligibilityResponse = await fetch(`http://localhost:6060/api/eligibility/course/${courseId}`);
                    const eligibilityData = await eligibilityResponse.json();

                    console.log("Eligibility data:", eligibilityData);

                    // Transform eligibility data to filter request format
                    const filterRequest = transformEligibilityToFilter(eligibilityData);
                    console.log("Filter request:", filterRequest);

                    // Call filter API with eligibility criteria
                    const filterResponse = await fetch('http://localhost:6060/api/personnel/filter', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(filterRequest)
                    });

                    if (filterResponse.ok) {
                        const filterResult = await filterResponse.json();
                        console.log("Filter result:", filterResult);

                        // Update officers array with filtered data
                        officers = filterResult.data || [];

                        // Clear previous selections
                        selectedSet.clear();
                        statusMap.clear();

                        // Update UI
                        document.getElementById("totalEligible").innerText = officers.length;
                        document.getElementById("selectedCount").innerText = "0";

                        // Render the table with filtered officers
                        renderOfficerTable();

                        // Update panel summary
                        updatePanelSummary();

                        showToast(`Found ${officers.length} eligible officers`, 'success');
                    }
                } catch (error) {
                    console.error("Error fetching eligibility or filters:", error);
                    showToast("Error loading eligible officers", 'error');
                } finally {
                    showLoading(false);
                }
            }
        });
    });

    // ===============================
    // TRANSFORM ELIGIBILITY DATA TO FILTER REQUEST
    // ===============================
    function transformEligibilityToFilter(eligibilityData) {
        // Map rank IDs to rank names (you'll need to maintain this mapping)
        const rankIdToName = {
            37: "Major",
            38: "Lieutenant Colonel",
            40: "Lieutenant Colonel",
            41: "Colonel",
            43: "Brigadier"
            // Add more mappings as needed
        };

        // Map medical category IDs to names
        const medicalIdToName = {
            21: "S1"
            // Add more mappings as needed
        };

        // Map unit IDs to unit names if needed
        // For now, we'll keep unitIds as is or you can fetch unit names

        const filterRequest = {
            rank: (eligibilityData.rankIds || []).map(id => rankIdToName[id] || null).filter(Boolean),
            medicalCategory: (eligibilityData.medicalCategories || []).map(id => medicalIdToName[id] || null).filter(Boolean),
            command: null,
            corps: null,
            division: null,
            establishmentType: eligibilityData.establishmentTypes || null,
            areaType: null,
            civilQualification: eligibilityData.educationalQualifications || null,
            sports: null,
            postingDueMonths: null,
            courseName: null,
            placeOfBirth: null,
            dobGreaterThan: eligibilityData.dobFrom || null,
            docFrom: eligibilityData.commissionDateFrom || null,
            docTo: eligibilityData.commissionDateTo || null,
            dosFrom: eligibilityData.seniorityDateFrom || null,
            dosTo: eligibilityData.seniorityDateTo || null,
            tosFrom: null,
            tosTo: null,
            courseFrom: null,
            courseTo: null,
            search: null,
            unitIds: eligibilityData.unitIds || null,
            remarks: eligibilityData.remarks || null,
            minCourseGrading: eligibilityData.minCourseGrading || null,
            postingTypeIds: eligibilityData.postingTypeIds || null,
            additionalRemarks: eligibilityData.additionalRemarks || null
        };

        return filterRequest;
    }

    // ===============================
    // STEP 2: PANEL STRENGTH
    // ===============================
    function loadStep2PanelStrength(courseId) {
        if (!courseId) {
            console.warn("Course ID missing");
            return;
        }

        fetch(`http://localhost:6060/api/courseschedule/step2/${courseId}`)
            .then(res => res.json())
            .then(data => {
                courseStrength = parseInt(data.courseStrength);
                panelSize = parseInt(data.panelSize);

                document.getElementById("courseStrength").value = courseStrength;
                document.getElementById("panelSize").value = panelSize;

                document.getElementById("logicText").innerText =
                    `Panel size (${panelSize}) = Course strength (${courseStrength}) + Buffer (10).`;

                sessionStorage.setItem("courseStrength", courseStrength);
                sessionStorage.setItem("panelSize", panelSize);
                sessionStorage.setItem("bufferSize", panelSize - courseStrength);
            })
            .catch(err => {
                console.error(err);
                document.getElementById("logicText").innerText = "Unable to load course strength";
            });
    }

    document.getElementById("increasePanel")?.addEventListener("click", () => {
        panelSize = parseInt(document.getElementById("panelSize").value) || 0;
        panelSize++;
        document.getElementById("panelSize").value = panelSize;

        sessionStorage.setItem("panelSize", panelSize);
        sessionStorage.setItem("bufferSize", panelSize - courseStrength);
    });

    document.getElementById("decreasePanel")?.addEventListener("click", () => {
        panelSize = parseInt(document.getElementById("panelSize").value) || 0;
        if (panelSize > courseStrength) {
            panelSize--;
            document.getElementById("panelSize").value = panelSize;

            sessionStorage.setItem("panelSize", panelSize);
            sessionStorage.setItem("bufferSize", panelSize - courseStrength);
        }
    });

    document.getElementById("courseStrength")?.addEventListener("input", () => {
        let courseVal = parseInt(document.getElementById("courseStrength").value) || 0;
        let panelVal = parseInt(document.getElementById("panelSize").value) || 0;

        if (panelVal < courseVal) {
            document.getElementById("panelSize").value = courseVal;
            panelVal = courseVal;
        }

        sessionStorage.setItem("courseStrength", courseVal);
        sessionStorage.setItem("panelSize", panelVal);
        sessionStorage.setItem("bufferSize", panelVal - courseVal);

        document.getElementById("logicText").innerText =
            `Panel size (${panelVal}) = Course strength (${courseVal}) + Buffer (${panelVal - courseVal}).`;
    });

    document.getElementById("panelSize")?.addEventListener("change", () => {
        let panelVal = parseInt(document.getElementById("panelSize").value) || 0;
        let courseVal = parseInt(document.getElementById("courseStrength").value) || 0;

        if (panelVal < courseVal) {
            document.getElementById("panelSize").value = courseVal;
            panelVal = courseVal;
        }

        sessionStorage.setItem("panelSize", panelVal);
        sessionStorage.setItem("bufferSize", panelVal - courseVal);

        document.getElementById("logicText").innerText =
            `Panel size (${panelVal}) = Course strength (${courseVal}) + Buffer (${panelVal - courseVal}).`;
    });

    // ===============================
    // FILTER POPUP FUNCTIONS
    // ===============================
    function openFilterPopup() {
        console.log("Opening filter popup");

        // Check if dropdown containers exist
        const rankDropdown = document.getElementById('dropdown-rankFilter');
        console.log("Rank dropdown container:", rankDropdown);

        document.getElementById('filterPopup').style.display = 'block';
        document.body.style.overflow = 'hidden';

        // Close any open dropdowns first
        document.querySelectorAll('.dropdown-content').forEach(dd => {
            dd.classList.remove('show');
        });

        // Initialize dropdown buttons AFTER popup is visible
        setTimeout(() => {
            initializeDropdowns();
            loadFilterDropdowns();
        }, 100);
    }

    // New function to initialize dropdowns
    function initializeDropdowns() {
        console.log("Initializing dropdowns");

        // Remove all existing click listeners from dropdown buttons
        document.querySelectorAll('.dropdown-btn').forEach(btn => {
            // Remove old listener
            btn.removeEventListener('click', dropdownClickHandler);
            // Add fresh listener
            btn.addEventListener('click', dropdownClickHandler);
        });
    }

    // Separate click handler function
    function dropdownClickHandler(e) {
        e.stopPropagation();
        const targetKey = this.dataset.target;
        const content = document.getElementById(`dropdown-${targetKey}`);
        if (!content) return;

        // Check if this dropdown is currently open
        const isOpen = content.classList.contains('show');

        // Close all dropdowns first
        document.querySelectorAll('.dropdown-content').forEach(dd => {
            dd.classList.remove('show');
        });

        // If it wasn't open, open it (toggle behavior)
        if (!isOpen) {
            content.classList.add('show');
            console.log(`Opened dropdown: ${targetKey}`);
        } else {
            console.log(`Closed dropdown: ${targetKey}`);
        }
    }

    function closeFilterPopup() {
        // Close all dropdowns when closing popup
        document.querySelectorAll('.dropdown-content').forEach(dd => {
            dd.classList.remove('show');
        });

        document.getElementById('filterPopup').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Load all dropdown data for filters
    async function loadFilterDropdowns() {
        console.log("Loading filter dropdowns..."); // Debug log
        try {
            await Promise.all([
                loadRankDropdown(),
                loadMedicalDropdown(),
                loadCommandDropdown(),
                loadCorpsDropdown(),
                loadDivisionDropdown(),
                loadEstablishmentDropdown(),
                loadAreaTypeDropdown(),
                loadCivilDropdown(),
                loadSportsDropdown(),
                loadPostingDueDropdown()
            ]);
            console.log("All dropdowns loaded"); // Debug log
        } catch (error) {
            console.error('Error loading filter dropdowns:', error);
        }
    }

    // Global click handler to close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        const isDropdownBtn = e.target.closest('.dropdown-btn');
        const isDropdownContent = e.target.closest('.dropdown-content');

        // If click is NOT on a dropdown button or content, close all dropdowns
        if (!isDropdownBtn && !isDropdownContent) {
            document.querySelectorAll('.dropdown-content').forEach(dd => {
                dd.classList.remove('show');
            });
        }
    });

    // Function to populate filter dropdown with checkboxes
    function populateFilterDropdown(dropdownId, items, selectedArrayRef, filterType) {
        const container = document.getElementById(dropdownId);
        if (!container) {
            console.error(`Container ${dropdownId} not found - retrying in 100ms`);
            setTimeout(() => {
                populateFilterDropdown(dropdownId, items, selectedArrayRef, filterType);
            }, 100);
            return;
        }

        console.log(`Populating ${dropdownId} with`, items.length, "items");
        container.innerHTML = '';

        if (!items || items.length === 0) {
            container.innerHTML = '<div style="padding:8px;color:#999;">No options available</div>';
            return;
        }

        items.forEach(item => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.style.padding = '8px 12px';
            label.style.cursor = 'pointer';
            label.style.borderBottom = '1px solid #f0f0f0';
            label.style.userSelect = 'none';

            const itemValue = typeof item === 'object' ? item.value || item.id || item : item;
            const itemText = typeof item === 'object' ? item.name || item.label || item : item;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = itemValue;
            checkbox.style.marginRight = '8px';
            checkbox.checked = selectedArrayRef.includes(itemValue);

            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                const val = checkbox.value;
                if (checkbox.checked) {
                    if (!selectedArrayRef.includes(val)) selectedArrayRef.push(val);
                } else {
                    const idx = selectedArrayRef.indexOf(val);
                    if (idx > -1) selectedArrayRef.splice(idx, 1);
                }
                updateFilterButtonText(dropdownId);
                applyAdvancedFilters();
            });

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(itemText));

            // Prevent dropdown from closing when clicking on the label
            label.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            container.appendChild(label);
        });

        updateFilterButtonText(dropdownId);
    }

    function updateFilterButtonText(dropdownId) {
        const target = dropdownId.replace('dropdown-', '');
        const btn = document.querySelector(`.dropdown-btn[data-target="${target}"]`);
        if (!btn) return;

        let selectedArray = [];
        if (target === 'rankFilter') selectedArray = rankSelected;
        else if (target === 'medicalFilter') selectedArray = medicalSelected;
        else if (target === 'commandFilter') selectedArray = commandSelected;
        else if (target === 'corpsFilter') selectedArray = corpsSelected;
        else if (target === 'divisionFilter') selectedArray = divisionSelected;
        else if (target === 'areaTypeFilter') selectedArray = areaTypeSelected;
        else if (target === 'estFilter') selectedArray = estSelected;
        else if (target === 'civilFilter') selectedArray = civilSelected;
        else if (target === 'sportsFilter') selectedArray = sportsSelected;
        else if (target === 'postingDueFilter') selectedArray = postingDueSelected;

        btn.innerText = selectedArray.length === 0 ?
            btn.innerText.split('(')[0].trim() :
            `${btn.innerText.split('(')[0].trim()} (${selectedArray.length} selected)`;
    }

    async function loadRankDropdown() {
        try {
            console.log("Fetching ranks..."); // Debug log
            const response = await fetch('http://localhost:6060/api/ranks');
            if (response.ok) {
                const ranks = await response.json();
                console.log("Ranks received:", ranks); // Debug log

                const items = ranks.map(rank => ({ value: rank, name: rank }));
                console.log("Rank items prepared:", items); // Debug log

                populateFilterDropdown('dropdown-rankFilter', items, rankSelected, 'rank');
            } else {
                console.error("Rank API returned:", response.status);
            }
        } catch (error) {
            console.error('Error loading ranks:', error);
        }
    }

    async function loadMedicalDropdown() {
        try {
            const response = await fetch('http://localhost:6060/api/master/filter/medical-category');
            if (response.ok) {
                const categories = await response.json();
                const items = categories.map(cat => ({ value: cat, name: cat }));
                populateFilterDropdown('dropdown-medicalFilter', items, medicalSelected, 'medical');
            }
        } catch (error) {
            console.error('Error loading medical categories:', error);
        }
    }

    async function loadCommandDropdown() {
        try {
            const response = await fetch('http://localhost:6060/api/dropdown/command');
            if (response.ok) {
                const commands = await response.json();
                const items = commands.map(cmd => ({ value: cmd, name: cmd }));
                populateFilterDropdown('dropdown-commandFilter', items, commandSelected, 'command');
            }
        } catch (error) {
            console.error('Error loading commands:', error);
        }
    }

    async function loadCorpsDropdown() {
        try {
            const response = await fetch('http://localhost:6060/api/dropdown/corps');
            if (response.ok) {
                const corpsList = await response.json();
                const items = corpsList.map(corps => ({ value: corps, name: corps }));
                populateFilterDropdown('dropdown-corpsFilter', items, corpsSelected, 'corps');
            }
        } catch (error) {
            console.error('Error loading corps:', error);
        }
    }

    async function loadDivisionDropdown() {
        try {
            const response = await fetch('http://localhost:6060/api/dropdown/division');
            if (response.ok) {
                const divisions = await response.json();
                const items = divisions.map(div => ({ value: div, name: div }));
                populateFilterDropdown('dropdown-divisionFilter', items, divisionSelected, 'division');
            }
        } catch (error) {
            console.error('Error loading divisions:', error);
        }
    }

    async function loadEstablishmentDropdown() {
        try {
            const response = await fetch('http://localhost:6060/api/master/filter/establishment-type');
            if (response.ok) {
                const types = await response.json();
                const items = types.map(type => ({ value: type, name: type }));
                populateFilterDropdown('dropdown-estFilter', items, estSelected, 'est');
            }
        } catch (error) {
            console.error('Error loading establishment types:', error);
        }
    }

    async function loadAreaTypeDropdown() {
        try {
            const response = await fetch('http://localhost:6060/api/master/filter/area-type');
            if (response.ok) {
                const areas = await response.json();
                const items = areas.map(area => ({ value: area, name: area }));
                populateFilterDropdown('dropdown-areaTypeFilter', items, areaTypeSelected, 'areaType');
            }
        } catch (error) {
            console.error('Error loading area types:', error);
        }
    }

    async function loadCivilDropdown() {
        try {
            const response = await fetch('http://localhost:6060/api/master/filter/civil-qualification');
            if (response.ok) {
                const quals = await response.json();
                const items = quals.map(qual => ({ value: qual, name: qual }));
                populateFilterDropdown('dropdown-civilFilter', items, civilSelected, 'civil');
            }
        } catch (error) {
            console.error('Error loading civil qualifications:', error);
        }
    }

    async function loadSportsDropdown() {
        try {
            const response = await fetch('http://localhost:6060/api/master/filter/sports');
            if (response.ok) {
                const sportsList = await response.json();
                const items = sportsList.map(sport => ({ value: sport, name: sport }));
                populateFilterDropdown('dropdown-sportsFilter', items, sportsSelected, 'sports');
            }
        } catch (error) {
            console.error('Error loading sports:', error);
        }
    }

    async function loadPostingDueDropdown() {
        try {
            const response = await fetch('http://localhost:6060/api/master/filter/posting-due-months');
            if (response.ok) {
                const months = await response.json();
                const items = months.map(month => ({ value: month, name: month + (month === 1 ? ' Month' : ' Months') }));
                populateFilterDropdown('dropdown-postingDueFilter', items, postingDueSelected, 'postingDue');
            }
        } catch (error) {
            console.error('Error loading posting due months:', error);
        }
    }

    // Build filter request from form
    function buildAdvancedFilterRequest() {
        return {
            rank: rankSelected.length ? rankSelected : null,
            medicalCategory: medicalSelected.length ? medicalSelected : null,
            command: commandSelected.length ? commandSelected : null,
            corps: corpsSelected.length ? corpsSelected : null,
            division: divisionSelected.length ? divisionSelected : null,
            establishmentType: estSelected.length ? estSelected : null,
            areaType: areaTypeSelected.length ? areaTypeSelected : null,
            civilQualification: civilSelected.length ? civilSelected : null,
            sports: sportsSelected.length ? sportsSelected : null,
            postingDueMonths: postingDueSelected.length ? postingDueSelected.map(v => parseInt(v)) : null,
            courseName: document.getElementById('courseNameFilter').value || null,
            placeOfBirth: document.getElementById('pobFilter').value || null,
            dobGreaterThan: document.getElementById('dobFilter').value || null,
            docFrom: document.getElementById('docFrom').value || null,
            docTo: document.getElementById('docTo').value || null,
            dosFrom: document.getElementById('dosFrom').value || null,
            dosTo: document.getElementById('dosTo').value || null,
            tosFrom: document.getElementById('tosFrom').value || null,
            tosTo: document.getElementById('tosTo').value || null,
            courseFrom: document.getElementById('courseFrom').value || null,
            courseTo: document.getElementById('courseTo').value || null,
            search: document.getElementById('globalSearch').value || null
        };
    }

    // ===============================
    // MODIFIED APPLY ADVANCED FILTERS
    // ===============================
    async function applyAdvancedFilters() {
        showLoading(true);

        try {
            const filterRequest = buildAdvancedFilterRequest();

            const response = await fetch('http://localhost:6060/api/personnel/filter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(filterRequest)
            });

            if (response.ok) {
                const data = await response.json();
                filterResults = data.data || [];

                // If this is called from the main page (not popup), update officers
                if (!document.getElementById('filterPopup').style.display ||
                    document.getElementById('filterPopup').style.display === 'none') {
                    officers = filterResults;
                    renderOfficerTable();
                    document.getElementById("totalEligible").innerText = officers.length;
                }

                renderFilterResultsTable();
                updateFilterCount();
            }
        } catch (error) {
            console.error('Error applying filters:', error);
            showToast('Error applying filters', 'error');
        } finally {
            showLoading(false);
        }
    }


    // Add loading indicator to the page
    function addLoadingIndicator() {
        const style = document.createElement('style');
        style.textContent = `
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1b4332;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
        document.head.appendChild(style);
    }

    // Call this on page load
    addLoadingIndicator();

    // Render results in popup table
    function renderFilterResultsTable() {
        const tbody = document.getElementById('filterResultsBody');

        if (!filterResults || filterResults.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
                        <div style="font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 8px;">No officers found</div>
                        <div style="color: #6b7280;">Try adjusting your filters</div>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        filterResults.forEach((o, index) => {
            const isSelected = selectedSet.has(o.personnelId);
            html += `
                <tr>
                    <td>
                        <input type="checkbox" class="result-checkbox" data-personnelid="${o.personnelId}" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>${o.armyNo || '‚Äî'}</td>
                    <td>
                        <div style="font-weight: 600">${o.fullName || '‚Äî'}</div>
                    </td>
                    <td>${o.rank || '‚Äî'}</td>
                    <td>${o.unit || '‚Äî'}</td>
                    <td>${o.command || '‚Äî'}</td>
                    <td>${o.medicalCategory || '‚Äî'}</td>
                    <td>${formatDate(o.dateOfBirth)}</td>
                    <td>${formatDate(o.dateOfCommission)}</td>
                    <td>${o.mobileNumber || '‚Äî'}</td>
                </tr>
            `;
        });

        tbody.innerHTML = html;

        document.querySelectorAll('.result-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const personnelId = parseInt(this.dataset.personnelid);
                if (this.checked) {
                    selectedSet.add(personnelId);
                } else {
                    selectedSet.delete(personnelId);
                }
                document.getElementById('selectedCount').innerText = selectedSet.size;
            });
        });
    }

    // Add selected officers from popup to main panel
    function addSelectedOfficers() {
        const selectedFromPopup = Array.from(document.querySelectorAll('.result-checkbox:checked'))
            .map(cb => parseInt(cb.dataset.personnelid));

        selectedFromPopup.forEach(id => selectedSet.add(id));

        if (filterResults.length > 0) {
            const existingIds = new Set(officers.map(o => o.personnelId));
            const newOfficers = filterResults.filter(o => !existingIds.has(o.personnelId));
            officers = [...officers, ...newOfficers];
        }

        renderOfficerTable();

        document.getElementById('selectedCount').innerText = selectedSet.size;
        document.getElementById('totalEligible').innerText = officers.length;

        updatePanelSummary();
        closeFilterPopup();

        showToast(`${selectedFromPopup.length} officers added to panel`, 'success');
    }

    // Update filter count badge
    function updateFilterCount() {
        const filterRequest = buildAdvancedFilterRequest();
        let count = 0;

        for (let key in filterRequest) {
            if (filterRequest[key] && filterRequest[key] !== null) {
                if (Array.isArray(filterRequest[key])) {
                    if (filterRequest[key].length > 0) count++;
                } else {
                    count++;
                }
            }
        }

        document.getElementById('activeFilterCount').innerText = `${count} filter${count !== 1 ? 's' : ''} applied`;
    }

    // Reset all filters
    function resetFilters() {
        // Clear all selected arrays
        rankSelected = [];
        medicalSelected = [];
        commandSelected = [];
        corpsSelected = [];
        divisionSelected = [];
        areaTypeSelected = [];
        estSelected = [];
        civilSelected = [];
        sportsSelected = [];
        postingDueSelected = [];

        // Clear all dropdown checkboxes
        document.querySelectorAll('.dropdown-content input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });

        // Reset button texts
        document.querySelectorAll('.dropdown-btn').forEach(btn => {
            const originalText = btn.innerText.split('(')[0].trim();
            btn.innerText = originalText;
        });

        const inputIds = [
            'globalSearch', 'courseNameFilter', 'pobFilter', 'dobFilter',
            'docFrom', 'docTo', 'dosFrom', 'dosTo', 'tosFrom', 'tosTo',
            'courseFrom', 'courseTo'
        ];

        inputIds.forEach(id => {
            const input = document.getElementById(id);
            if (input) input.value = '';
        });

        filterResults = [];
        document.getElementById('filterResultsBody').innerHTML = `
        <tr>
            <td colspan="10" style="text-align: center; padding: 40px;">
                <div style="color: #6b7280;">Click "Apply Filters" to load results</div>
            </td>
        </tr>
    `;

        document.getElementById('activeFilterCount').innerText = '0 filters applied';
    }

    function clearAllFilters() {
        resetFilters();
    }

    // ===============================
    // OFFICER TABLE FUNCTIONS
    // ===============================
    function loadOfficers() {
        // This function is now modified to use the filter API instead of the panel/officers API
        // But we'll keep it for initial load or fallback
        fetch("http://localhost:6060/api/personnel/filter", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({}) // Empty filter to get all officers
        })
            .then(res => res.json())
            .then(data => {
                officers = Array.isArray(data.data) ? data.data : [];
                document.getElementById("totalEligible").innerText = officers.length;
                renderOfficerTable();
                updatePanelSummary();
            })
            .catch(err => console.error("Officer load error", err));
    }

    function renderOfficerTable() {
        const tbody = document.getElementById("officerTableBody");
        if (!tbody) return;

        tbody.innerHTML = "";

        if (!officers || officers.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="17" style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üë§</div>
                    <div style="font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 8px;">No eligible officers found</div>
                    <div style="color: #6b7280;">Select a course to view eligible officers</div>
                </td>
            </tr>
        `;
            return;
        }

        officers.forEach((o, index) => {
            const isSelected = selectedSet.has(o.id || o.personnelId);
            const isAttending = attendingSet.has(o.id || o.personnelId);
            const status = statusMap.get(o.id || o.personnelId) || 'Reserve';

            const row = document.createElement("tr");

            row.innerHTML = `
            <td><input type="checkbox" ${isSelected ? "checked" : ""} data-personnelid="${o.id || o.personnelId}" class="officer-checkbox"></td>
            <td>${index + 1}</td>
            <td>
                <div style="display:flex;align-items:center;gap:10px">
                    <img src="http://localhost:6060/${o.officerImage || 'uploads/default.png'}"
                         style="width:36px;height:36px;border-radius:50%;object-fit:cover"
                         onerror="this.src='http://localhost:6060/uploads/default.png'" />
                    <div>
                        <div style="font-weight:600">${o.fullName || o.name || "-"}</div>
                        <div style="font-size:12px;color:#6b7280">${o.armyNo || "-"}</div>
                    </div>
                </div>
            </td>
            <td>${o.rank || "-"}</td>
            <td>${o.unit || "-"}</td>
            <td>${o.command || "-"}</td>
            <td>${formatDate(o.dateOfCommission)}</td>
            <td>${formatDate(o.dateOfSeniority)}</td>
            <td>${formatDate(o.dateOfBirth)}</td>
            <td>${o.religion || "-"}</td>
            <td>${o.maritalStatus || "-"}</td>
            <td>${o.medicalCategory || "-"}</td>
            <td>${o.mobileNumber || o.mobile || "-"}</td>
            <td>${o.emailAddress || o.email || "-"}</td>
            <td>${o.city || "-"}</td>
            <td>${o.state || "-"}</td>
            <td>
                <span class="badge ${status === 'Retain' ? 'badge-success' : 'badge-warning'}">${status}</span>
            </td>
        `;

            tbody.appendChild(row);

            const checkbox = row.querySelector('.officer-checkbox');
            checkbox.addEventListener('change', function() {
                const personnelId = parseInt(this.dataset.personnelid);
                if (this.checked) {
                    selectedSet.add(personnelId);
                } else {
                    selectedSet.delete(personnelId);
                    statusMap.delete(personnelId);
                }
                document.getElementById('selectedCount').innerText = selectedSet.size;
                updatePanelSummary();
            });
        });

        document.getElementById('selectedCount').innerText = selectedSet.size;
    }


    // ===============================
    // PANEL SUMMARY
    // ===============================
    function updatePanelSummary() {
        const panelSize = parseInt(sessionStorage.getItem('panelSize')) || 0;
        const courseStrength = parseInt(sessionStorage.getItem('courseStrength')) || 0;
        const bufferSize = parseInt(sessionStorage.getItem('bufferSize')) || 0;

        document.getElementById('panelTotalNominated').innerText = selectedSet.size;
        document.getElementById('panelCourseSeats').innerText = courseStrength;
        document.getElementById('panelBufferSeats').innerText = bufferSize;
        document.getElementById('panelAttendingCount').innerText = attendingSet.size;
    }

    // ===============================
    // STEP 3 SAVE
    // ===============================
    function handleStep3Save() {
        const scheduleId = sessionStorage.getItem("scheduleId");

        if (!scheduleId) {
            alert("Please select a course schedule first.");
            return;
        }

        if (selectedSet.size === 0) {
            console.log("No officers selected. Skipping save.");
            currentStep++;
            renderStep();
            return;
        }

        const nominations = Array.from(selectedSet).map(personnelId => ({
            personnelId,
            status: statusMap.get(personnelId) || "Reserve"
        }));

        const payload = {
            scheduleId: parseInt(scheduleId),
            nominations
        };

        fetch("http://localhost:6060/api/course-panel/nomination", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to save panel");
                alert("Panel saved successfully");
                currentStep++;
                renderStep();
            })
            .catch(err => {
                console.error(err);
                alert("Personnel Already Exists");
            });
    }

    // ===============================
    // STEP 4 FUNCTIONS
    // ===============================
    function loadStep4Panel() {
        const scheduleId = sessionStorage.getItem("scheduleId");

        if (!scheduleId) return;

        fetch(`http://localhost:6060/api/course-panel/nomination/${scheduleId}`)
            .then(res => res.json())
            .then(panelData => {
                const personnelIds = panelData.map(p => p.personnelId);

                if (personnelIds.length === 0) {
                    renderEmptyStep4();
                    return;
                }

                fetch("http://localhost:6060/api/panel/officers")
                    .then(res => res.json())
                    .then(allOfficers => {
                        const finalList = allOfficers.filter(o =>
                            personnelIds.includes(o.personnelId)
                        );
                        renderStep4Table(finalList);
                    });
            })
            .catch(err => console.error("Step-4 error", err));
    }

    function renderStep4Table(officers) {
        const tbody = document.getElementById("finalApprovalTableBody");
        if (!tbody) return;

        tbody.innerHTML = "";

        if (!Array.isArray(officers) || officers.length === 0) {
            renderEmptyStep4();
            return;
        }

        officers.forEach((o, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:10px">
                        <img src="http://localhost:6060/${o.officerImage || 'uploads/default.png'}"
                             style="width:36px;height:36px;border-radius:50%;object-fit:cover" />
                        <div>
                            <div style="font-weight:600">${o.fullName}</div>
                            <div style="font-size:12px;color:#6b7280">${o.armyNo}</div>
                        </div>
                    </div>
                </td>
                <td>${o.rank || "-"}</td>
                <td>${o.unit || "-"}</td>
                <td>${o.command || "-"}</td>
                <td>${formatDate(o.dateOfCommission)}</td>
                <td>${formatDate(o.dateOfSeniority)}</td>
                <td>${formatDate(o.dateOfBirth)}</td>
                <td>${o.religion || "-"}</td>
                <td>${o.maritalStatus || "-"}</td>
                <td>${o.medicalCategory || "-"}</td>
                <td>${o.mobileNumber || "-"}</td>
                <td>${o.emailAddress || "-"}</td>
                <td>${o.city || "-"}</td>
                <td>${o.state || "-"}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderEmptyStep4() {
        const tbody = document.getElementById("finalApprovalTableBody");
        tbody.innerHTML = `
            <tr>
                <td colspan="15" style="text-align:center;color:#6b7280;padding:20px;">
                    No officers nominated for this schedule
                </td>
            </tr>
        `;
    }

    // ===============================
    // STEP 5 FUNCTIONS
    // ===============================
    function loadStep5Panel() {
        const scheduleId = sessionStorage.getItem("scheduleId");
        if (!scheduleId) return;

        fetch(`http://localhost:6060/api/course-panel/nomination/${scheduleId}`)
            .then(res => res.json())
            .then(panelData => {
                const personnelIds = panelData
                    .filter(p => p.status === "Retain")
                    .map(p => p.personnelId);

                if (personnelIds.length === 0) {
                    renderEmptyStep5();
                    return;
                }

                fetch("http://localhost:6060/api/panel/officers")
                    .then(res => res.json())
                    .then(allOfficers => {
                        const finalList = allOfficers.filter(o =>
                            personnelIds.includes(o.personnelId)
                        );
                        renderStep5Table(finalList);
                    });
            })
            .catch(err => console.error("Step-5 error", err));
    }

    function renderStep5Table(officers) {
        const tbody = document.getElementById("step5TableBody");
        if (!tbody) return;

        tbody.innerHTML = "";

        if (!Array.isArray(officers) || officers.length === 0) {
            renderEmptyStep5();
            return;
        }

        officers.forEach((o, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:10px">
                        <img src="http://localhost:6060/${o.officerImage || 'uploads/default.png'}"
                             style="width:36px;height:36px;border-radius:50%;object-fit:cover" />
                        <div>
                            <div style="font-weight:600">${o.fullName}</div>
                            <div style="font-size:12px;color:#6b7280">${o.armyNo}</div>
                        </div>
                    </div>
                </td>
                <td>${o.rank || "-"}</td>
                <td>${o.unit || "-"}</td>
                <td>${o.command || "-"}</td>
                <td>${formatDate(o.dateOfCommission)}</td>
                <td>${formatDate(o.dateOfSeniority)}</td>
                <td>${formatDate(o.dateOfBirth)}</td>
                <td>${o.mobileNumber || "-"}</td>
                <td>${o.emailAddress || "-"}</td>
                <td>${o.city || "-"}</td>
                <td>${o.state || "-"}</td>
                <td>
                    <button class="btn btn-primary" onclick="generateLetter(${o.personnelId})" style="padding: 6px 12px;">
                        üìÑ Generate
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderEmptyStep5() {
        const tbody = document.getElementById("step5TableBody");
        tbody.innerHTML = `
            <tr>
                <td colspan="13" style="text-align:center;color:#6b7280;padding:20px;">
                    No officers available for letter generation
                </td>
            </tr>
        `;
    }

    function generateLetter(personnelId) {
        showToast('Letter generation feature coming soon!', 'info');
    }

    // ===============================
    // UTILITY FUNCTIONS
    // ===============================
    function formatDate(dateStr) {
        if (!dateStr) return "-";
        const d = new Date(dateStr);
        return d.toLocaleDateString("en-GB");
    }

    function showLoading(show) {
        const applyBtn = document.getElementById('applyAdvancedFiltersBtn');
        if (applyBtn) {
            applyBtn.disabled = show;
            applyBtn.textContent = show ? 'Loading...' : 'Apply Filters';
        }
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
            <span>${message}</span>
        `;

        document.getElementById('toastContainer').appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // ===============================
    // SELECT / DESELECT ALL
    // ===============================
    document.getElementById("selectAllBtn")?.addEventListener("click", () => {
        officers.forEach(o => selectedSet.add(o.personnelId));
        document.getElementById("selectedCount").innerText = selectedSet.size;
        renderOfficerTable();
        updatePanelSummary();
    });

    document.getElementById("deselectAllBtn")?.addEventListener("click", () => {
        selectedSet.clear();
        statusMap.clear();
        document.getElementById("selectedCount").innerText = 0;
        renderOfficerTable();
        updatePanelSummary();
    });

    // ===============================
    // SEND FOR APPROVAL
    // ===============================
    document.getElementById("sendToApproval")?.addEventListener("click", () => {
        const scheduleId = sessionStorage.getItem("scheduleId");
        const roleId = document.getElementById("sendToRole")?.value;
        const remark = document.getElementById("approvalRemark")?.value || "";

        if (!scheduleId) {
            alert("Schedule ID missing. Please select course first.");
            return;
        }

        if (!roleId) {
            alert("Please select a role to send approval.");
            return;
        }

        const payload = {
            scheduleId: parseInt(scheduleId),
            roleId: parseInt(roleId),
            status: "pending",
            remark: remark.trim()
        };

        fetch("http://localhost:6060/api/course-schedule-role-status", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to send for approval");
                return res.json();
            })
            .then(data => {
                alert("Panel sent for approval successfully.");
            })
            .catch(err => {
                console.error(err);
                alert("Error while sending for approval.");
            });
    });

    // ===============================
    // LOAD SEND TO ROLES
    // ===============================
    function loadSendToRoles() {
        const select = document.getElementById("sendToRole");
        if (!select) return;

        fetch("http://localhost:6060/api/roles/summary")
            .then(res => res.json())
            .then(data => {
                if (!Array.isArray(data)) return;
                data.forEach(role => {
                    const option = document.createElement("option");
                    option.value = role.roleId;
                    option.textContent = role.roleName;
                    select.appendChild(option);
                });
            })
            .catch(err => {
                console.error("Failed to load roles", err);
            });
    }

    // ===============================
    // UPDATE INITIALIZATION
    // ===============================
    document.addEventListener("DOMContentLoaded", function() {
        // Don't load officers immediately - wait for course selection
        // loadOfficers(); - Comment this out or remove it

        // Load roles for step 4
        loadSendToRoles();

        // Set up filter event listeners
        document.getElementById('globalSearch')?.addEventListener('keyup', debounce(function() {
            applyAdvancedFilters();
        }, 500));

        const dateInputs = [
            'dobFilter', 'docFrom', 'docTo', 'dosFrom', 'dosTo',
            'tosFrom', 'tosTo', 'courseFrom', 'courseTo'
        ];

        dateInputs.forEach(id => {
            document.getElementById(id)?.addEventListener('change', applyAdvancedFilters);
        });

        document.getElementById('courseNameFilter')?.addEventListener('change', applyAdvancedFilters);
        document.getElementById('pobFilter')?.addEventListener('change', applyAdvancedFilters);

        // Close popup when clicking outside
        window.addEventListener('click', function(event) {
            const popup = document.getElementById('filterPopup');
            if (event.target === popup) {
                closeFilterPopup();
            }
        });

        // Initialize with empty officers array
        officers = [];
        renderOfficerTable();
    });
</script>
</body>
</html>